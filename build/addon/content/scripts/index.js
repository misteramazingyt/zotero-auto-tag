"use strict";(()=>{var At=Object.create;var at=Object.defineProperty;var Rt=Object.getOwnPropertyDescriptor;var Kt=Object.getOwnPropertyNames;var Nt=Object.getPrototypeOf,Bt=Object.prototype.hasOwnProperty;var v=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var Mt=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Kt(e))!Bt.call(s,r)&&r!==t&&at(s,r,{get:()=>e[r],enumerable:!(i=Rt(e,r))||i.enumerable});return s};var xe=(s,e,t)=>(t=s!=null?At(Nt(s)):{},Mt(e||!s||!s.__esModule?at(t,"default",{value:s,enumerable:!0}):t,s));var lt=v(V=>{"use strict";var Ht=V&&V.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(V,"__esModule",{value:!0});V.DebugBridge=void 0;var Te=y(),Et=Ht(P()),$=class s{get version(){return s.version}get disableDebugBridgePassword(){return this._disableDebugBridgePassword}set disableDebugBridgePassword(e){this._disableDebugBridgePassword=e}get password(){return Te.BasicTool.getZotero().Prefs.get(s.passwordPref,!0)}set password(e){Te.BasicTool.getZotero().Prefs.set(s.passwordPref,e,!0)}constructor(){this._disableDebugBridgePassword=!1,this.initializeDebugBridge()}static setModule(e){var t;(!(!((t=e.debugBridge)===null||t===void 0)&&t.version)||e.debugBridge.version<s.version)&&(e.debugBridge=new s)}initializeDebugBridge(){let e={noContent:!0,doAction:async t=>{var i;let r=Te.BasicTool.getZotero(),o=r.getMainWindow(),a=t.spec.split("//").pop();if(!a)return;let n={};(i=a.split("?").pop())===null||i===void 0||i.split("&").forEach(h=>{n[h.split("=")[0]]=decodeURIComponent(h.split("=")[1])});let c=Et.default.getInstance().debugBridge.disableDebugBridgePassword,l=!1;if(c?l=!0:typeof n.password>"u"&&typeof this.password>"u"?l=o.confirm(`External App ${n.app} wants to execute command without password.
Command:
${(n.run||n.file||"").slice(0,100)}
If you do not know what it is, please click Cancel to deny.`):l=this.password===n.password,l){if(n.run)try{let h=Object.getPrototypeOf(async function(){}).constructor;await new h("Zotero,window",n.run)(r,o)}catch(h){r.debug(h),o.console.log(h)}if(n.file)try{Services.scriptloader.loadSubScript(n.file,{Zotero:r,window:o})}catch(h){r.debug(h),o.console.log(h)}}},newChannel:function(t){this.doAction(t)}};Services.io.getProtocolHandler("zotero").wrappedJSObject._extensions["zotero://ztoolkit-debug"]=e}};V.DebugBridge=$;$.version=2;$.passwordPref="extensions.zotero.debug-bridge.password"});var dt=v(Q=>{"use strict";Object.defineProperty(Q,"__esModule",{value:!0});Q.PluginBridge=void 0;var Gt=y(),J=class s{get version(){return s.version}constructor(){this.initializePluginBridge()}static setModule(e){var t;(!(!((t=e.pluginBridge)===null||t===void 0)&&t.version)||e.pluginBridge.version<s.version)&&(e.pluginBridge=new s)}initializePluginBridge(){let{AddonManager:e}=ChromeUtils.import("resource://gre/modules/AddonManager.jsm"),t=Gt.BasicTool.getZotero(),i={noContent:!0,doAction:async r=>{var o;try{let a=r.spec.split("//").pop();if(!a)return;let n={};if((o=a.split("?").pop())===null||o===void 0||o.split("&").forEach(c=>{n[c.split("=")[0]]=decodeURIComponent(c.split("=")[1])}),n.action==="install"&&n.url){if(n.minVersion&&Services.vc.compare(t.version,n.minVersion)<0||n.maxVersion&&Services.vc.compare(t.version,n.maxVersion)>0)throw new Error(`Plugin is not compatible with Zotero version ${t.version}.The plugin requires Zotero version between ${n.minVersion} and ${n.maxVersion}.`);let c=await e.getInstallForURL(n.url);if(c&&c.state===e.STATE_AVAILABLE)c.install(),ct("Plugin installed successfully.",!0);else throw new Error(`Plugin ${n.url} is not available.`)}}catch(a){t.logError(a),ct(a.message,!1)}},newChannel:function(r){this.doAction(r)}};Services.io.getProtocolHandler("zotero").wrappedJSObject._extensions["zotero://plugin"]=i}};Q.PluginBridge=J;J.version=1;function ct(s,e){let t=new Zotero.ProgressWindow({closeOnClick:!0});t.changeHeadline("Plugin Toolkit"),t.progress=new t.ItemProgress(e?"chrome://zotero/skin/tick.png":"chrome://zotero/skin/cross.png",s),t.progress.setProgress(100),t.show(),t.startCloseTimer(5e3)}});var P=v(j=>{"use strict";Object.defineProperty(j,"__esModule",{value:!0});j.ToolkitGlobal=void 0;var Ie=y(),Wt=lt(),$t=dt(),U=class s{constructor(){ut(this),this.currentWindow=Ie.BasicTool.getZotero().getMainWindow()}static getInstance(){let e=Ie.BasicTool.getZotero(),t=!1;"_toolkitGlobal"in e||(e._toolkitGlobal=new s,t=!0);let i=e._toolkitGlobal;return i.currentWindow!==e.getMainWindow()&&(jt(i),t=!0),t&&ut(i),i}};j.ToolkitGlobal=U;function ut(s){A(s,"fieldHooks",{_ready:!1,getFieldHooks:{},setFieldHooks:{},isFieldOfBaseHooks:{}}),A(s,"itemTree",{_ready:!1,columns:[],renderCellHooks:{}}),A(s,"itemBox",{_ready:!1,fieldOptions:{}}),A(s,"shortcut",{_ready:!1,eventKeys:[]}),A(s,"prompt",{_ready:!1,instance:void 0}),A(s,"readerInstance",{_ready:!1,initializedHooks:{}}),Wt.DebugBridge.setModule(s),$t.PluginBridge.setModule(s)}function A(s,e,t){var i,r;if(t){s[e]||(s[e]=t);for(let o in t)(i=(r=s[e])[o])!==null&&i!==void 0||(r[o]=t[o])}}function jt(s){s.currentWindow=Ie.BasicTool.getZotero().getMainWindow(),s.itemTree=void 0,s.itemBox=void 0,s.shortcut=void 0,s.prompt=void 0,s.readerInstance=void 0}j.default=U});var y=v(T=>{"use strict";var Dt=T&&T.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(T,"__esModule",{value:!0});T.ManagerTool=T.BasicTool=void 0;T.unregister=Jt;T.makeHelperTool=Qt;var Ot=Dt(P()),D=class s{get basicOptions(){return this._basicOptions}constructor(e){this.patchSign="zotero-plugin-toolkit@2.0.0",this._basicOptions={log:{_type:"toolkitlog",disableConsole:!1,disableZLog:!1,prefix:""},debug:Ot.default.getInstance().debugBridge,api:{pluginID:"zotero-plugin-toolkit@windingwind.com"},listeners:{callbacks:{onMainWindowLoad:new Set,onMainWindowUnload:new Set,onPluginUnload:new Set},_mainWindow:void 0,_plugin:void 0}},this.updateOptions(e)}getGlobal(e){let t=typeof Zotero<"u"?Zotero:Components.classes["@zotero.org/Zotero;1"].getService(Components.interfaces.nsISupports).wrappedJSObject;try{let i=t.getMainWindow();switch(e){case"Zotero":case"zotero":return t;case"window":return i;case"windows":return t.getMainWindows();case"document":return i.document;case"ZoteroPane":case"ZoteroPane_Local":return t.getActiveZoteroPane();default:return i[e]}}catch(i){Zotero.logError(i)}}isZotero7(){return Zotero.platformMajorVersion>=102}isFX115(){return Zotero.platformMajorVersion>=115}getDOMParser(){if(this.isZotero7())return new(this.getGlobal("DOMParser"));try{return new(this.getGlobal("DOMParser"))}catch{return Components.classes["@mozilla.org/xmlextras/domparser;1"].createInstance(Components.interfaces.nsIDOMParser)}}isXULElement(e){return e.namespaceURI==="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"}createXULElement(e,t){return this.isZotero7()?e.createXULElement(t):e.createElementNS("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul",t)}log(...e){var t;if(e.length===0)return;let i=this.getGlobal("Zotero"),r=this.getGlobal("console"),o;((t=e[e.length-1])===null||t===void 0?void 0:t._type)==="toolkitlog"?o=e.pop():o=this._basicOptions.log;try{o.prefix&&e.splice(0,0,o.prefix),o.disableConsole||(r.groupCollapsed(...e),r.trace(),r.groupEnd()),o.disableZLog||i.debug(e.map(a=>{try{return typeof a=="object"?JSON.stringify(a):String(a)}catch{return i.debug(a),""}}).join(`
`))}catch(a){r.error(a),i.logError(a)}}patch(e,t,i,r){if(e[t][i])throw new Error(`${String(t)} re-patched`);this.log("patching",t,`by ${i}`),e[t]=r(e[t]),e[t][i]=!0}addListenerCallback(e,t){["onMainWindowLoad","onMainWindowUnload"].includes(e)&&this._ensureMainWindowListener(),e==="onPluginUnload"&&this._ensurePluginListener(),this._basicOptions.listeners.callbacks[e].add(t)}removeListenerCallback(e,t){this._basicOptions.listeners.callbacks[e].delete(t),this._ensureRemoveListener()}_ensureRemoveListener(){let{listeners:e}=this._basicOptions;e._mainWindow&&e.callbacks.onMainWindowLoad.size===0&&e.callbacks.onMainWindowUnload.size===0&&(Services.wm.removeListener(e._mainWindow),delete e._mainWindow),e._plugin&&e.callbacks.onPluginUnload.size===0&&(Zotero.Plugins.removeObserver(e._plugin),delete e._plugin)}_ensureMainWindowListener(){if(this._basicOptions.listeners._mainWindow)return;let e={onOpenWindow:t=>{let i=t.docShell.domWindow,r=async()=>{if(i.removeEventListener("load",r,!1),i.location.href==="chrome://zotero/content/zoteroPane.xhtml")for(let o of this._basicOptions.listeners.callbacks.onMainWindowLoad)try{o(i)}catch(a){this.log(a)}};i.addEventListener("load",()=>r(),!1)},onCloseWindow:async t=>{let i=t.docShell.domWindow;if(i.location.href==="chrome://zotero/content/zoteroPane.xhtml")for(let r of this._basicOptions.listeners.callbacks.onMainWindowUnload)try{r(i)}catch(o){this.log(o)}}};this._basicOptions.listeners._mainWindow=e,Services.wm.addListener(e)}_ensurePluginListener(){if(this._basicOptions.listeners._plugin)return;let e={shutdown:(...t)=>{for(let i of this._basicOptions.listeners.callbacks.onPluginUnload)try{i(...t)}catch(r){this.log(r)}}};this._basicOptions.listeners._plugin=e,Zotero.Plugins.addObserver(e)}updateOptions(e){return e?(e instanceof s?this._basicOptions=e._basicOptions:this._basicOptions=e,this):this}static getZotero(){return typeof Zotero<"u"?Zotero:Components.classes["@zotero.org/Zotero;1"].getService(Components.interfaces.nsISupports).wrappedJSObject}};T.BasicTool=D;var X=class extends D{_ensureAutoUnregisterAll(){this.addListenerCallback("onPluginUnload",(e,t)=>{e.id===this.basicOptions.api.pluginID&&this.unregisterAll()})}};T.ManagerTool=X;function Jt(s){Object.values(s).forEach(e=>{(e instanceof X||typeof e?.unregisterAll=="function")&&e.unregisterAll()})}function Qt(s,e){return new Proxy(s,{construct(t,i){let r=new s(...i);return r instanceof D&&r.updateOptions(e),r}})}});var C=v(Y=>{"use strict";Object.defineProperty(Y,"__esModule",{value:!0});Y.UITool=void 0;var Ut=y(),Ce=class extends Ut.BasicTool{get basicOptions(){return this._basicOptions}constructor(e){super(e),this.elementCache=[],this._basicOptions.ui||(this._basicOptions.ui={enableElementRecord:!0,enableElementJSONLog:!1,enableElementDOMLog:!0})}unregisterAll(){this.elementCache.forEach(e=>{var t;try{(t=e?.deref())===null||t===void 0||t.remove()}catch(i){this.log(i)}})}createElement(...e){var t,i,r;let o=e[0],a=e[1].toLowerCase(),n=e[2]||{};if(!a)return;typeof e[2]=="string"&&(n={namespace:e[2],enableElementRecord:e[3]}),(typeof n.enableElementJSONLog<"u"&&n.enableElementJSONLog||this.basicOptions.ui.enableElementJSONLog)&&this.log(n),n.properties=n.properties||n.directAttributes,n.children=n.children||n.subElementOptions;let c;if(a==="fragment")c=o.createDocumentFragment();else{let l=n.id&&(n.checkExistenceParent?n.checkExistenceParent:o).querySelector(`#${n.id}`);if(l&&n.ignoreIfExists)return l;if(l&&n.removeIfExists&&(l.remove(),l=void 0),n.customCheck&&!n.customCheck(o,n))return;if(!l||!n.skipIfExists){let h=n.namespace;if(!h){let f=Xt.includes(a),u=Yt.includes(a),p=ei.includes(a);Number(f)+Number(u)+Number(p)>1&&this.log(`[Warning] Creating element ${a} with no namespace specified. Found multiply namespace matches.`),f?h="html":u?h="xul":p?h="svg":h="html"}h==="xul"?l=this.createXULElement(o,a):l=o.createElementNS({html:"http://www.w3.org/1999/xhtml",svg:"http://www.w3.org/2000/svg"}[h],a),(typeof n.enableElementRecord<"u"?n.enableElementRecord:this.basicOptions.ui.enableElementRecord)&&this.elementCache.push(new WeakRef(l))}n.id&&(l.id=n.id),n.styles&&Object.keys(n.styles).length&&Object.keys(n.styles).forEach(h=>{let f=n.styles[h];typeof f<"u"&&(l.style[h]=f)}),n.properties&&Object.keys(n.properties).length&&Object.keys(n.properties).forEach(h=>{let f=n.properties[h];typeof f<"u"&&(l[h]=f)}),n.attributes&&Object.keys(n.attributes).length&&Object.keys(n.attributes).forEach(h=>{let f=n.attributes[h];typeof f<"u"&&l.setAttribute(h,String(f))}),!((t=n.classList)===null||t===void 0)&&t.length&&l.classList.add(...n.classList),!((i=n.listeners)===null||i===void 0)&&i.length&&n.listeners.forEach(({type:h,listener:f,options:u})=>{f&&l.addEventListener(h,f,u)}),c=l}if(!((r=n.children)===null||r===void 0)&&r.length){let l=n.children.map(h=>(h.namespace=h.namespace||n.namespace,this.createElement(o,h.tag,h))).filter(h=>h);c.append(...l)}return(typeof n.enableElementDOMLog<"u"?n.enableElementDOMLog:this.basicOptions.ui.enableElementDOMLog)&&this.log(c),c}appendElement(e,t){return t.appendChild(this.createElement(t.ownerDocument,e.tag,e))}insertElementBefore(e,t){if(t.parentNode)return t.parentNode.insertBefore(this.createElement(t.ownerDocument,e.tag,e),t);this.log(t.tagName+" has no parent, cannot insert "+e.tag)}replaceElement(e,t){if(t.parentNode)return t.parentNode.replaceChild(this.createElement(t.ownerDocument,e.tag,e),t);this.log(t.tagName+" has no parent, cannot replace it with "+e.tag)}parseXHTMLToFragment(e,t=[],i=!0){let r=this.getDOMParser(),o="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul",a="http://www.w3.org/1999/xhtml",n=`${t.length?`<!DOCTYPE bindings [ ${t.reduce((h,f,u)=>h+`<!ENTITY % _dtd-${u} SYSTEM "${f}"> %_dtd-${u}; `,"")}]>`:""}
      <html:div xmlns="${i?o:a}"
          xmlns:xul="${o}" xmlns:html="${a}">
      ${e}
      </html:div>`;this.log(n,r);let c=r.parseFromString(n,"text/xml");if(this.log(c),c.documentElement.localName==="parsererror")throw new Error("not well-formed XHTML");let l=c.createRange();return l.selectNodeContents(c.querySelector("div")),l.extractContents()}};Y.UITool=Ce;var Xt=["a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","kbd","label","legend","li","link","main","map","mark","menu","meta","meter","nav","noscript","object","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","script","section","select","slot","small","source","span","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr"],Yt=["action","arrowscrollbox","bbox","binding","bindings","box","broadcaster","broadcasterset","button","browser","checkbox","caption","colorpicker","column","columns","commandset","command","conditions","content","deck","description","dialog","dialogheader","editor","grid","grippy","groupbox","hbox","iframe","image","key","keyset","label","listbox","listcell","listcol","listcols","listhead","listheader","listitem","member","menu","menubar","menuitem","menulist","menupopup","menuseparator","observes","overlay","page","popup","popupset","preference","preferences","prefpane","prefwindow","progressmeter","radio","radiogroup","resizer","richlistbox","richlistitem","row","rows","rule","script","scrollbar","scrollbox","scrollcorner","separator","spacer","splitter","stack","statusbar","statusbarpanel","stringbundle","stringbundleset","tab","tabbrowser","tabbox","tabpanel","tabpanels","tabs","template","textnode","textbox","titlebar","toolbar","toolbarbutton","toolbargrippy","toolbaritem","toolbarpalette","toolbarseparator","toolbarset","toolbarspacer","toolbarspring","toolbox","tooltip","tree","treecell","treechildren","treecol","treecols","treeitem","treerow","treeseparator","triple","vbox","window","wizard","wizardpage"],ei=["a","animate","animateMotion","animateTransform","circle","clipPath","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","foreignObject","g","image","line","linearGradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialGradient","rect","script","set","stop","style","svg","switch","symbol","text","textPath","title","tspan","use","view"]});var Pe=v(ee=>{"use strict";Object.defineProperty(ee,"__esModule",{value:!0});ee.waitUntil=ii;ee.waitUtilAsync=ri;var ti=y(),R=new ti.BasicTool;function ii(s,e,t=100,i=1e4){let r=Date.now(),o=R.getGlobal("setInterval")(()=>{s()?(R.getGlobal("clearInterval")(o),e()):Date.now()-r>i&&R.getGlobal("clearInterval")(o)},t)}function ri(s,e=100,t=1e4){return new Promise((i,r)=>{let o=Date.now(),a=R.getGlobal("setInterval")(()=>{s()?(R.getGlobal("clearInterval")(a),i()):Date.now()-o>t&&(R.getGlobal("clearInterval")(a),r())},e)})}});var ze=v(te=>{"use strict";Object.defineProperty(te,"__esModule",{value:!0});te.ReaderTool=void 0;var si=y(),oi=Pe(),Le=class extends si.BasicTool{async getReader(e=5e3){let t=this.getGlobal("Zotero_Tabs");if(t.selectedType!=="reader")return;let i=Zotero.Reader.getByTabID(t.selectedID),r=0,o=50;for(;!i&&r*o<e;)await Zotero.Promise.delay(o),i=Zotero.Reader.getByTabID(t.selectedID),r++;return await i?._initPromise,i}getWindowReader(){let e=this.getGlobal("Zotero_Tabs"),t=[],i=e._tabs.map(r=>r.id);for(let r=0;r<Zotero.Reader._readers.length;r++){let o=!1;for(let a=0;a<i.length;a++)if(Zotero.Reader._readers[r].tabID==i[a]){o=!0;break}o||t.push(Zotero.Reader._readers[r])}return t}getReaderTabPanelDeck(){var e;return(e=this.getGlobal("window").document.querySelector(".notes-pane-deck"))===null||e===void 0?void 0:e.previousElementSibling}async addReaderTabPanelDeckObserver(e){await(0,oi.waitUtilAsync)(()=>!!this.getReaderTabPanelDeck());let t=this.getReaderTabPanelDeck(),i=new(this.getGlobal("MutationObserver"))(async r=>{r.forEach(async o=>{let a=o.target;(a.classList.contains("zotero-view-tabbox")||a.tagName==="deck")&&e()})});return i.observe(t,{attributes:!0,attributeFilter:["selectedIndex"],subtree:!0}),i}getSelectedAnnotationData(e){var t;return(t=e?._internalReader._lastView._selectionPopup)===null||t===void 0?void 0:t.annotation}getSelectedText(e){var t,i;return(i=(t=this.getSelectedAnnotationData(e))===null||t===void 0?void 0:t.text)!==null&&i!==void 0?i:""}};te.ReaderTool=Le});var ht=v(ie=>{"use strict";Object.defineProperty(ie,"__esModule",{value:!0});ie.ExtraFieldTool=void 0;var ni=y(),Ze=class extends ni.BasicTool{getExtraFields(e,t="custom"){let i=e.getField("extra");if(t==="default")return this.getGlobal("Zotero").Utilities.Internal.extractExtraFields(i).fields;{let r=new Map,o=[];return i.split(`
`).forEach(a=>{let n=a.split(": ");n.length>=2&&n[0]?r.set(n[0],n.slice(1).join(": ")):o.push(a)}),r.set("__nonStandard__",o.join(`
`)),r}}getExtraField(e,t){return this.getExtraFields(e).get(t)}async replaceExtraFields(e,t){let i=[];t.has("__nonStandard__")&&(i.push(t.get("__nonStandard__")),t.delete("__nonStandard__")),t.forEach((r,o)=>{i.push(`${o}: ${r}`)}),e.setField("extra",i.join(`
`)),await e.saveTx()}async setExtraField(e,t,i){let r=this.getExtraFields(e);i===""||typeof i>"u"?r.delete(t):r.set(t,i),await this.replaceExtraFields(e,r)}};ie.ExtraFieldTool=Ze});var Se=v(re=>{"use strict";Object.defineProperty(re,"__esModule",{value:!0});re.PatchHelper=void 0;var ai=y(),qe=class extends ai.BasicTool{constructor(){super(),this.options=void 0}setData(e){this.options=e;let t=this.getGlobal("Zotero"),{target:i,funcSign:r,patcher:o}=e,a=i[r];return this.log("patching ",r),i[r]=function(...n){if(e.enabled)try{return o(a).apply(this,n)}catch(c){t.logError(c)}return a.apply(this,n)},this}enable(){if(!this.options)throw new Error("No patch data set");return this.options.enabled=!0,this}disable(){if(!this.options)throw new Error("No patch data set");return this.options.enabled=!1,this}};re.PatchHelper=qe});var oe=v(se=>{"use strict";Object.defineProperty(se,"__esModule",{value:!0});se.FieldHookManager=void 0;var Fe=Se(),li=y(),Ve=class extends li.ManagerTool{constructor(e){super(e),this.data={getField:{},setField:{},isFieldOfBase:{}},this.patchHelpers={getField:new Fe.PatchHelper,setField:new Fe.PatchHelper,isFieldOfBase:new Fe.PatchHelper};let t=this;for(let i of Object.keys(this.patchHelpers))this.patchHelpers[i].setData({target:this.getGlobal("Zotero").Item.prototype,funcSign:i,patcher:o=>function(a,...n){let c=this,l=t.data[i][a];if(typeof l=="function")try{return l(a,n[0],n[1],c,o)}catch(h){return a+String(h)}return o.apply(c,[a,...n])},enabled:!0})}register(e,t,i){this.data[e][t]=i}unregister(e,t){delete this.data[e][t]}unregisterAll(){this.data.getField={},this.data.setField={},this.data.isFieldOfBase={},this.patchHelpers.getField.disable(),this.patchHelpers.setField.disable(),this.patchHelpers.isFieldOfBase.disable()}};se.FieldHookManager=Ve});var Re=v(ne=>{"use strict";Object.defineProperty(ne,"__esModule",{value:!0});ne.PatcherManager=void 0;var ci=y(),Ae=class extends ci.ManagerTool{constructor(e){super(e),this.patcherIDMap=new Map}register(e,t,i){let r=this.getGlobal("Zotero"),o=this.patcherIDMap,a=r.randomString();for(;o.has(a);)a=r.randomString();let n=e[t];return o.set(a,!0),this.log("patching ",t),e[t]=function(...c){if(o.get(a))try{return i(n).apply(this,c)}catch(l){r.logError(l)}return n.apply(this,c)},a}unregister(e){this.patcherIDMap.delete(e)}unregisterAll(){this.patcherIDMap.clear()}};ne.PatcherManager=Ae});var ft=v(K=>{"use strict";var di=K&&K.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(K,"__esModule",{value:!0});K.ItemTreeManager=void 0;var ui=y(),hi=oe(),fi=di(P()),pi=Re(),Ke=class extends ui.ManagerTool{constructor(e){super(e),this.defaultPersist=["width","ordinal","hidden","sortActive","sortDirection"],this.backend=this.getGlobal("Zotero").ItemTreeManager,this.localColumnCache=[],this.localRenderCellCache=[],this.fieldHooks=new hi.FieldHookManager(e),this.patcherManager=new pi.PatcherManager(e),this.initializationLock=this.getGlobal("Zotero").Promise.defer(),this.backend?this.initializationLock.resolve():this.initializeGlobal()}unregisterAll(){[...this.localColumnCache].forEach(e=>this.unregister(e,{skipGetField:!0})),[...this.localRenderCellCache].forEach(this.removeRenderCellHook.bind(this)),this.fieldHooks.unregisterAll()}async register(e,t,i,r={showInColumnPicker:!0}){var o;if(await((o=this.initializationLock)===null||o===void 0?void 0:o.promise),!this.backend&&this.globalCache.columns.map(n=>n.dataKey).includes(e)){this.log(`ItemTreeTool: ${e} is already registered.`);return}let a={dataKey:e,label:t,pluginID:this._basicOptions.api.pluginID,iconLabel:r.iconPath?this.createIconLabel({iconPath:r.iconPath,name:t}):void 0,iconPath:r.iconPath,htmlLabel:r.htmlLabel,zoteroPersist:r.zoteroPersist||(this.backend?this.defaultPersist:new Set(this.defaultPersist)),defaultIn:r.defaultIn,disabledIn:r.disabledIn,enabledTreeIDs:r.enabledTreeIDs,defaultSort:r.defaultSort,sortReverse:r.sortReverse||r.defaultSort===-1,flex:typeof r.flex>"u"?1:r.flex,width:r.width,fixedWidth:r.fixedWidth,staticWidth:r.staticWidth,minWidth:r.minWidth,ignoreInColumnPicker:r.ignoreInColumnPicker,showInColumnPicker:typeof r.ignoreInColumnPicker>"u"?!0:r.showInColumnPicker,submenu:r.submenu,columnPickerSubMenu:r.columnPickerSubMenu||r.submenu,dataProvider:r.dataProvider||((n,c)=>n.getField(e)),renderCell:r.renderCell||r.renderCellHook};if(i&&this.fieldHooks.register("getField",e,i),this.backend)return await this.backend.registerColumns(a);this.globalCache.columns.push(a),this.localColumnCache.push(a.dataKey),r.renderCellHook&&await this.addRenderCellHook(e,r.renderCellHook),await this.refresh()}async unregister(e,t={}){if(await this.initializationLock.promise,this.backend){await this.backend.unregisterColumns(e),t.skipGetField||this.fieldHooks.unregister("getField",e);return}let i=this.getGlobal("Zotero"),r=i.Prefs.get("pane.persist"),o=JSON.parse(r);delete o[e],i.Prefs.set("pane.persist",JSON.stringify(o));let a=this.globalCache.columns.map(c=>c.dataKey).indexOf(e);a>=0&&this.globalCache.columns.splice(a,1),t.skipGetField||this.fieldHooks.unregister("getField",e),this.removeRenderCellHook(e),await this.refresh();let n=this.localColumnCache.indexOf(e);n>=0&&this.localColumnCache.splice(n,1)}async addRenderCellHook(e,t){await this.initializationLock.promise,e in this.globalCache.renderCellHooks&&this.log("[WARNING] ItemTreeTool.addRenderCellHook overwrites an existing hook:",e),this.globalCache.renderCellHooks[e]=t,this.localRenderCellCache.push(e)}async removeRenderCellHook(e){delete this.globalCache.renderCellHooks[e];let t=this.localRenderCellCache.indexOf(e);t>=0&&this.localRenderCellCache.splice(t,1),await this.refresh()}async initializeGlobal(){await this.getGlobal("Zotero").uiReadyPromise;let t=this.getGlobal("window");this.globalCache=fi.default.getInstance().itemTree;let i=this.globalCache;if(!i._ready){i._ready=!0;let r=t.require("zotero/itemTree");this.backend||this.patcherManager.register(r.prototype,"getColumns",o=>function(){let a=o.apply(this,arguments),n=a.findIndex(c=>c.dataKey==="title");return a.splice(n+1,0,...i.columns),a}),this.patcherManager.register(r.prototype,"_renderCell",o=>function(a,n,c){if(!(c.dataKey in i.renderCellHooks))return o.apply(this,arguments);let l=i.renderCellHooks[c.dataKey],h=l(a,n,c,o.bind(this));if(h.classList.contains("cell"))return h;let f=t.document.createElementNS("http://www.w3.org/1999/xhtml","span");return f.classList.add("cell",c.dataKey,`${c.dataKey}-item-tree-main-default`),c.fixedWidth&&f.classList.add("fixed-width"),f.appendChild(h),f})}this.initializationLock.resolve()}createIconLabel(e){let t=window.require("react");return t.createElement("span",null,t.createElement("img",{src:e.iconPath,height:"10px",width:"9px",style:{"margin-left":"6px"}})," ",e.name)}async refresh(){var e,t;await this.initializationLock.promise;let r=this.getGlobal("ZoteroPane").itemsView;if(!r)return;r._columnsId=null;let o=(e=r.tree)===null||e===void 0?void 0:e._columns;if(!o){this.log("ItemTree is still loading. Refresh skipped.");return}(t=document.querySelector(`.${o._styleKey}`))===null||t===void 0||t.remove(),await r.refreshAndMaintainSelection(),r.tree._columns=new o.__proto__.constructor(r.tree),await r.refreshAndMaintainSelection()}};K.ItemTreeManager=Ke});var pt=v(L=>{"use strict";var mi=L&&L.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(L,"__esModule",{value:!0});L.PromptManager=L.Prompt=void 0;var gi=y(),bi=y(),yi=C(),vi=mi(P()),ae=class{get document(){return this.base.getGlobal("document")}constructor(){this.lastInputText="",this.defaultText={placeholder:"Select a command...",empty:"No commands found."},this.maxLineNum=12,this.maxSuggestionNum=100,this.commands=[],this.base=new gi.BasicTool,this.ui=new yi.UITool,this.initializeUI()}initializeUI(){this.addStyle(),this.createHTML(),this.initInputEvents(),this.registerShortcut()}createHTML(){this.promptNode=this.ui.createElement(this.document,"div",{styles:{display:"none"},children:[{tag:"div",styles:{position:"fixed",left:"0",top:"0",backgroundColor:"transparent",width:"100%",height:"100%"},listeners:[{type:"click",listener:()=>{this.promptNode.style.display="none"}}]}]}),this.promptNode.appendChild(this.ui.createElement(this.document,"div",{id:"zotero-plugin-toolkit-prompt",classList:["prompt-container"],children:[{tag:"div",classList:["input-container"],children:[{tag:"input",classList:["prompt-input"],attributes:{type:"text",placeholder:this.defaultText.placeholder}},{tag:"div",classList:["cta"]}]},{tag:"div",classList:["commands-containers"]},{tag:"div",classList:["instructions"],children:[{tag:"div",classList:["instruction"],children:[{tag:"span",classList:["key"],properties:{innerText:"\u2191\u2193"}},{tag:"span",properties:{innerText:"to navigate"}}]},{tag:"div",classList:["instruction"],children:[{tag:"span",classList:["key"],properties:{innerText:"enter"}},{tag:"span",properties:{innerText:"to trigger"}}]},{tag:"div",classList:["instruction"],children:[{tag:"span",classList:["key"],properties:{innerText:"esc"}},{tag:"span",properties:{innerText:"to exit"}}]}]}]})),this.inputNode=this.promptNode.querySelector("input"),this.document.documentElement.appendChild(this.promptNode)}showCommands(e,t=!1){t&&this.promptNode.querySelectorAll(".commands-container").forEach(r=>r.remove()),this.inputNode.placeholder=this.defaultText.placeholder;let i=this.createCommandsContainer();for(let r of e){try{if(!r.name||r.when&&!r.when())continue}catch{continue}i.appendChild(this.createCommandNode(r))}}createCommandsContainer(){let e=this.ui.createElement(this.document,"div",{classList:["commands-container"]});return this.promptNode.querySelectorAll(".commands-container").forEach(t=>{t.style.display="none"}),this.promptNode.querySelector(".commands-containers").appendChild(e),e}getCommandsContainer(){return[...Array.from(this.promptNode.querySelectorAll(".commands-container"))].find(e=>e.style.display!="none")}createCommandNode(e){let t=this.ui.createElement(this.document,"div",{classList:["command"],children:[{tag:"div",classList:["content"],children:[{tag:"div",classList:["name"],children:[{tag:"span",properties:{innerText:e.name}}]},{tag:"div",classList:["aux"],children:e.label?[{tag:"span",classList:["label"],properties:{innerText:e.label}}]:[]}]}],listeners:[{type:"mousemove",listener:()=>{this.selectItem(t)}},{type:"click",listener:async()=>{await this.execCallback(e.callback)}}]});return t.command=e,t}trigger(){[...Array.from(this.promptNode.querySelectorAll(".commands-container"))].find(e=>e.style.display!="none").querySelector(".selected").click()}exit(){if(this.inputNode.placeholder=this.defaultText.placeholder,this.promptNode.querySelectorAll(".commands-containers .commands-container").length>=2){this.promptNode.querySelector(".commands-container:last-child").remove();let e=this.promptNode.querySelector(".commands-container:last-child");e.style.display="",e.querySelectorAll(".commands").forEach(t=>t.style.display="flex"),this.inputNode.focus()}else this.promptNode.style.display="none"}async execCallback(e){Array.isArray(e)?this.showCommands(e):await e(this)}async showSuggestions(e){var t=/[\u2000-\u206F\u2E00-\u2E7F\\'!"#$%&()*+,\-.\/:;<=>?@\[\]^_`{|}~]/,i=/\s/,r=/[\u0F00-\u0FFF\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/;function o(u,p,d,m){if(u.length===0)return 0;var g=0;g-=Math.max(0,u.length-1),g-=m/10;var b=u[0][0];return g-=(u[u.length-1][1]-b+1-p)/100,g-=b/1e3,g-=d/1e4}function a(u,p,d,m){if(u.length===0)return null;for(var g=d.toLowerCase(),b=0,w=0,k=[],Z=0;Z<u.length;Z++){var S=u[Z],x=g.indexOf(S,w);if(x===-1)return null;var F=d.charAt(x);if(x>0&&!t.test(F)&&!r.test(F)){var W=d.charAt(x-1);if(F.toLowerCase()!==F&&W.toLowerCase()!==W||F.toUpperCase()!==F&&!t.test(W)&&!i.test(W)&&!r.test(W))if(m){if(x!==w){w+=S.length,Z--;continue}}else b+=1}if(k.length===0)k.push([x,x+S.length]);else{var nt=k[k.length-1];nt[1]<x?k.push([x,x+S.length]):nt[1]=x+S.length}w=x+S.length}return{matches:k,score:o(k,p.length,g.length,b)}}function n(u){for(var p=u.toLowerCase(),d=[],m=0,g=0;g<p.length;g++){var b=p.charAt(g);i.test(b)?(m!==g&&d.push(p.substring(m,g)),m=g+1):(t.test(b)||r.test(b))&&(m!==g&&d.push(p.substring(m,g)),d.push(b),m=g+1)}return m!==p.length&&d.push(p.substring(m,p.length)),{query:u,tokens:d,fuzzy:p.split("")}}function c(u,p){if(u.query==="")return{score:0,matches:[]};var d=a(u.tokens,u.query,p,!1);return d||a(u.fuzzy,u.query,p,!0)}var l=n(e);let h=this.getCommandsContainer();if(h.classList.contains("suggestions")&&this.exit(),e.trim()=="")return!0;let f=[];if(this.getCommandsContainer().querySelectorAll(".command").forEach(u=>{let d=u.querySelector(".name span").innerText,m=c(l,d);if(m){u=this.createCommandNode(u.command);let g="",b=0;for(let w=0;w<m.matches.length;w++){let[k,Z]=m.matches[w];k>b&&(g+=d.slice(b,k)),g+=`<span class="highlight">${d.slice(k,Z)}</span>`,b=Z}b<d.length&&(g+=d.slice(b,d.length)),u.querySelector(".name span").innerHTML=g,f.push({score:m.score,commandNode:u})}}),f.length>0)return f.sort((u,p)=>p.score-u.score).slice(this.maxSuggestionNum),h=this.createCommandsContainer(),h.classList.add("suggestions"),f.forEach(u=>{h.appendChild(u.commandNode)}),!0;{let u=this.commands.find(p=>!p.name&&(!p.when||p.when()));return u?await this.execCallback(u.callback):this.showTip(this.defaultText.empty),!1}}initInputEvents(){this.promptNode.addEventListener("keydown",e=>{if(["ArrowUp","ArrowDown"].indexOf(e.key)!=-1){e.preventDefault();let t,i=[...Array.from(this.getCommandsContainer().querySelectorAll(".command"))].filter(o=>o.style.display!="none");t=i.findIndex(o=>o.classList.contains("selected")),t!=-1?(i[t].classList.remove("selected"),t+=e.key=="ArrowUp"?-1:1):e.key=="ArrowUp"?t=i.length-1:t=0,t==-1?t=i.length-1:t==i.length&&(t=0),i[t].classList.add("selected");let r=this.getCommandsContainer();r.scrollTo(0,r.querySelector(".selected").offsetTop-r.offsetHeight+7.5),i[t].classList.add("selected")}}),this.promptNode.addEventListener("keyup",async e=>{if(e.key=="Enter")this.trigger();else if(e.key=="Escape")this.inputNode.value.length>0?this.inputNode.value="":this.exit();else if(["ArrowUp","ArrowDown"].indexOf(e.key)!=-1)return;let t=this.inputNode.value;t!=this.lastInputText&&(this.lastInputText=t,window.setTimeout(async()=>{await this.showSuggestions(t)}))})}showTip(e){let t=this.ui.createElement(this.document,"div",{classList:["tip"],properties:{innerText:e}}),i=this.createCommandsContainer();return i.classList.add("suggestions"),i.appendChild(t),t}selectItem(e){this.getCommandsContainer().querySelectorAll(".command").forEach(t=>t.classList.remove("selected")),e.classList.add("selected")}addStyle(){let e=this.ui.createElement(this.document,"style",{namespace:"html",id:"prompt-style"});e.innerText=`
      .prompt-container * {
        box-sizing: border-box;
      }
      .prompt-container {
        ---radius---: 10px;
        position: fixed;
        left: 25%;
        top: 10%;
        width: 50%;
        border-radius: var(---radius---);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        box-shadow: 0px 1.8px 7.3px rgba(0, 0, 0, 0.071),
                    0px 6.3px 24.7px rgba(0, 0, 0, 0.112),
                    0px 30px 90px rgba(0, 0, 0, 0.2);
        font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Microsoft YaHei Light", sans-serif;
        background-color: var(--material-background) !important;
        border: var(--material-border-quarternary) !important;
      }
      
      /* input */
      .prompt-container .input-container  {
        width: 100%;
      }

      .input-container input {
        width: -moz-available;
        height: 40px;
        padding: 24px;
        border: none;
        outline: none;
        font-size: 18px;
        margin: 0 !important;
        border-radius: var(---radius---);
        background-color: var(--material-background);
      }
      
      .input-container .cta {
        border-bottom: var(--material-border-quarternary);
        margin: 5px auto;
      }
      
      /* results */
      .commands-containers {
        width: 100%;
        height: 100%;
      }
      .commands-container {
        max-height: calc(${this.maxLineNum} * 35.5px);
        width: calc(100% - 12px);
        margin-left: 12px;
        margin-right: 0%;
        overflow-y: auto;
        overflow-x: hidden;
      }
      
      .commands-container .command {
        display: flex;
        align-content: baseline;
        justify-content: space-between;
        border-radius: 5px;
        padding: 6px 12px;
        margin-right: 12px;
        margin-top: 2px;
        margin-bottom: 2px;
      }
      .commands-container .command .content {
        display: flex;
        width: 100%;
        justify-content: space-between;
        flex-direction: row;
        overflow: hidden;
      }
      .commands-container .command .content .name {
        white-space: nowrap; 
        text-overflow: ellipsis;
        overflow: hidden;
      }
      .commands-container .command .content .aux {
        display: flex;
        align-items: center;
        align-self: center;
        flex-shrink: 0;
      }
      
      .commands-container .command .content .aux .label {
        font-size: 15px;
        color: var(--fill-primary);
        padding: 2px 6px;
        background-color: var(--color-background);
        border-radius: 5px;
      }
      
      .commands-container .selected {
          background-color: var(--material-mix-quinary);
      }

      .commands-container .highlight {
        font-weight: bold;
      }

      .tip {
        color: var(--fill-primary);
        text-align: center;
        padding: 12px 12px;
        font-size: 18px;
      }

      /* instructions */
      .instructions {
        display: flex;
        align-content: center;
        justify-content: center;
        font-size: 15px;
        height: 2.5em;
        width: 100%;
        border-top: var(--material-border-quarternary);
        color: var(--fill-secondary);
        margin-top: 5px;
      }
      
      .instructions .instruction {
        margin: auto .5em;  
      }
      
      .instructions .key {
        margin-right: .2em;
        font-weight: 600;
      }
    `,this.document.documentElement.appendChild(e)}registerShortcut(){this.document.addEventListener("keydown",e=>{if(e.shiftKey&&e.key.toLowerCase()=="p"){if(e.originalTarget.isContentEditable||"value"in e.originalTarget||this.commands.length==0)return;e.preventDefault(),e.stopPropagation(),this.promptNode.style.display=="none"?(this.promptNode.style.display="flex",this.promptNode.querySelectorAll(".commands-container").length==1&&this.showCommands(this.commands,!0),this.promptNode.focus(),this.inputNode.focus()):this.promptNode.style.display="none"}},!0)}};L.Prompt=ae;var Ne=class extends bi.ManagerTool{constructor(e){super(e),this.commands=[];let t=vi.default.getInstance().prompt;t._ready||(t._ready=!0,t.instance=new ae),this.prompt=t.instance}register(e){e.forEach(t=>{var i;return(i=t.id)!==null&&i!==void 0?i:t.id=t.name}),this.prompt.commands=[...this.prompt.commands,...e],this.commands=[...this.commands,...e],this.prompt.showCommands(this.commands,!0)}unregister(e){this.prompt.commands=this.prompt.commands.filter(t=>t.id!=e),this.commands=this.commands.filter(t=>t.id!=e)}unregisterAll(){this.prompt.commands=this.prompt.commands.filter(e=>this.commands.every(t=>t.id!=e.id)),this.commands=[]}};L.PromptManager=Ne});var mt=v(le=>{"use strict";Object.defineProperty(le,"__esModule",{value:!0});le.LibraryTabPanelManager=void 0;var wi=C(),ki=y(),Be=class extends ki.ManagerTool{constructor(e){super(e),this.ui=new wi.UITool(this),this.libraryTabCache={optionsList:[]}}register(e,t,i){i=i||{tabId:void 0,panelId:void 0,targetIndex:-1,selectPanel:!1};let r=this.getGlobal("window"),o=r.document.querySelector("#zotero-view-tabbox"),a=`${Zotero.Utilities.randomString()}-${new Date().getTime()}`,n=i.tabId||`toolkit-readertab-${a}`,c=i.panelId||`toolkit-readertabpanel-${a}`,l=this.ui.createElement(r.document,"tab",{id:n,classList:[`toolkit-ui-tabs-${n}`],attributes:{label:e},ignoreIfExists:!0}),h=this.ui.createElement(r.document,"tabpanel",{id:c,classList:[`toolkit-ui-tabs-${n}`],ignoreIfExists:!0}),f=o.querySelector("tabs"),u=o.querySelector("tabpanels"),p=typeof i.targetIndex=="number"?i.targetIndex:-1;return p>=0?(f.querySelectorAll("tab")[p].before(l),u.querySelectorAll("tabpanel")[p].before(h)):(f.appendChild(l),u.appendChild(h)),i.selectPanel&&(o.selectedTab=l),this.libraryTabCache.optionsList.push({tabId:n,tabLabel:e,panelId:c,renderPanelHook:t,targetIndex:p,selectPanel:i.selectPanel}),t(h,r),n}unregister(e){let t=this.libraryTabCache.optionsList.findIndex(i=>i.tabId===e);t>=0&&this.libraryTabCache.optionsList.splice(t,1),this.removeTabPanel(e)}unregisterAll(){this.libraryTabCache.optionsList.map(t=>t.tabId).forEach(this.unregister.bind(this))}removeTabPanel(e){let t=this.getGlobal("document");Array.prototype.forEach.call(t.querySelectorAll(`.toolkit-ui-tabs-${e}`),i=>{i.remove()})}};le.LibraryTabPanelManager=Be});var gt=v(ce=>{"use strict";Object.defineProperty(ce,"__esModule",{value:!0});ce.ReaderTabPanelManager=void 0;var _i=C(),xi=ze(),Ti=y(),Me=class extends Ti.ManagerTool{constructor(e){super(e),this.ui=new _i.UITool(this),this.readerTool=new xi.ReaderTool(this),this.readerTabCache={optionsList:[],observer:void 0,initializeLock:void 0}}async register(e,t,i){var r;i=i||{tabId:void 0,panelId:void 0,targetIndex:-1,selectPanel:!1},typeof this.readerTabCache.initializeLock>"u"&&await this.initializeReaderTabObserver(),await((r=this.readerTabCache.initializeLock)===null||r===void 0?void 0:r.promise);let o=`${Zotero.Utilities.randomString()}-${new Date().getTime()}`,a=i.tabId||`toolkit-readertab-${o}`,n=i.panelId||`toolkit-readertabpanel-${o}`,c=typeof i.targetIndex=="number"?i.targetIndex:-1;return this.readerTabCache.optionsList.push({tabId:a,tabLabel:e,panelId:n,renderPanelHook:t,targetIndex:c,selectPanel:i.selectPanel}),await this.addReaderTabPanel(),a}unregister(e){var t;let i=this.readerTabCache.optionsList.findIndex(r=>r.tabId===e);i>=0&&this.readerTabCache.optionsList.splice(i,1),this.readerTabCache.optionsList.length===0&&((t=this.readerTabCache.observer)===null||t===void 0||t.disconnect(),this.readerTabCache={optionsList:[],observer:void 0,initializeLock:void 0}),this.removeTabPanel(e)}unregisterAll(){this.readerTabCache.optionsList.map(t=>t.tabId).forEach(this.unregister.bind(this))}changeTabPanel(e,t){let i=this.readerTabCache.optionsList.findIndex(r=>r.tabId===e);i>=0&&Object.assign(this.readerTabCache.optionsList[i],t)}removeTabPanel(e){let t=this.getGlobal("document");Array.prototype.forEach.call(t.querySelectorAll(`.toolkit-ui-tabs-${e}`),i=>{i.remove()})}async initializeReaderTabObserver(){this.readerTabCache.initializeLock=this.getGlobal("Zotero").Promise.defer(),await Promise.all([Zotero.initializationPromise,Zotero.unlockPromise,Zotero.uiReadyPromise]);let e=Zotero.Promise.defer();e.resolve();let t=await this.readerTool.addReaderTabPanelDeckObserver(async()=>{await e.promise,e=Zotero.Promise.defer();try{this.addReaderTabPanel()}catch{}e.resolve()});this.readerTabCache.observer=t,this.readerTabCache.initializeLock.resolve()}async addReaderTabPanel(){var e,t;let i=this.getGlobal("window"),r=this.readerTool.getReaderTabPanelDeck(),o=await this.readerTool.getReader();if(!o)return;if(((e=r.selectedPanel)===null||e===void 0?void 0:e.children[0].tagName)==="vbox"){let l=r.selectedPanel;l.innerHTML="",this.ui.appendElement({tag:"tabbox",classList:["zotero-view-tabbox"],attributes:{flex:"1"},enableElementRecord:!1,children:[{tag:"tabs",classList:["zotero-editpane-tabs"],attributes:{orient:"horizontal"},enableElementRecord:!1},{tag:"tabpanels",classList:["zotero-view-item"],attributes:{flex:"1"},enableElementRecord:!1}]},l)}let a=(t=r.selectedPanel)===null||t===void 0?void 0:t.querySelector("tabbox");if(!a)return;let n=a.querySelector("tabs"),c=a.querySelector("tabpanels");this.readerTabCache.optionsList.forEach(l=>{let h=`${l.tabId}-${o._instanceID}`,f=`toolkit-ui-tabs-${l.tabId}`;if(n?.querySelector(`.${f}`))return;let u=this.ui.createElement(i.document,"tab",{id:h,classList:[f],attributes:{label:l.tabLabel},ignoreIfExists:!0}),p=this.ui.createElement(i.document,"tabpanel",{id:`${l.panelId}-${o._instanceID}`,classList:[f],ignoreIfExists:!0});l.targetIndex>=0?(n?.querySelectorAll("tab")[l.targetIndex].before(u),c?.querySelectorAll("tabpanel")[l.targetIndex].before(p),a.getAttribute("toolkit-select-fixed")!=="true"&&(a.tabpanels.addEventListener("select",()=>{this.getGlobal("setTimeout")(()=>{a.tabpanels.selectedPanel=a.tabs.getRelatedElement(a?.tabs.selectedItem)},0)}),a.setAttribute("toolkit-select-fixed","true"))):(n?.appendChild(u),c?.appendChild(p)),l.selectPanel&&(a.selectedTab=u),l.renderPanelHook(p,r,i,o)})}};ce.ReaderTabPanelManager=Me});var bt=v(de=>{"use strict";Object.defineProperty(de,"__esModule",{value:!0});de.MenuManager=void 0;var Ii=C(),Ci=y(),He=class extends Ci.ManagerTool{constructor(e){super(e),this.ui=new Ii.UITool(this)}register(e,t,i="after",r){let o;if(typeof e=="string"?o=this.getGlobal("document").querySelector(Ee[e]):o=e,!o)return!1;let a=o.ownerDocument,n=l=>{var h,f;let u={tag:l.tag,id:l.id,namespace:"xul",attributes:{label:l.label||"",hidden:!!l.hidden,disaled:!!l.disabled,class:l.class||"",oncommand:l.oncommand||""},classList:l.classList,styles:l.styles||{},listeners:[],children:[]};l.icon&&(this.getGlobal("Zotero").isMac||(l.tag==="menu"?u.attributes.class+=" menu-iconic":u.attributes.class+=" menuitem-iconic"),u.styles["list-style-image"]=`url(${l.icon})`),l.commandListener&&((h=u.listeners)===null||h===void 0||h.push({type:"command",listener:l.commandListener}));let p=this.ui.createElement(a,l.tag,u);if(l.getVisibility&&o.addEventListener("popupshowing",d=>{l.getVisibility(p,d)?p.removeAttribute("hidden"):p.setAttribute("hidden","true")}),l.tag==="menu"){let d=this.ui.createElement(a,"menupopup",{id:l.popupId,attributes:{onpopupshowing:l.onpopupshowing||""}});(f=l.children)===null||f===void 0||f.forEach(m=>{d.append(n(m))}),p.append(d)}return p},c=n(t);r||(r=i==="after"?o.lastElementChild:o.firstElementChild),r[i](c)}unregister(e){var t;(t=this.getGlobal("document").querySelector(`#${e}`))===null||t===void 0||t.remove()}unregisterAll(){this.ui.unregisterAll()}};de.MenuManager=He;var Ee;(function(s){s.menuFile="#menu_FilePopup",s.menuEdit="#menu_EditPopup",s.menuView="#menu_viewPopup",s.menuGo="#menu_goPopup",s.menuTools="#menu_ToolsPopup",s.menuHelp="#menu_HelpPopup",s.collection="#zotero-collectionmenu",s.item="#zotero-itemmenu"})(Ee||(Ee={}))});var yt=v(ue=>{"use strict";Object.defineProperty(ue,"__esModule",{value:!0});ue.PreferencePaneManager=void 0;var Pi=C(),Li=y(),Ge=class extends Li.ManagerTool{constructor(e){super(e),this.alive=!0,this.ui=new Pi.UITool(this),this.prefPaneCache={win:void 0,listeners:{}}}register(e){if(this.isZotero7()){this.getGlobal("Zotero").PreferencePanes.register(e);return}let t=r=>{var o;let a=new Map,n=this.getGlobal("Zotero"),c=r.ownerGlobal,l=d=>d instanceof c.HTMLInputElement&&d.type=="checkbox"||d.tagName=="checkbox",h=(d,m)=>{let g=n.Prefs.get(m,!0);l(d)?d.checked=g:d.value=g,d.dispatchEvent(new c.Event("syncfrompreference"))},f=d=>{let m=d.currentTarget;if(m?.getAttribute("preference")){let g=l(m)?m.checked:m.value;n.Prefs.set(m.getAttribute("preference")||"",g,!0),m.dispatchEvent(new c.Event("synctopreference"))}},u=(d,m)=>{n.debug(`Attaching <${d.tagName}> element to ${m}`);let g=n.Prefs.registerObserver(m,()=>h(d,m),!0);a.set(d,g)},p=d=>{a.has(d)&&(n.debug(`Detaching <${d.tagName}> element from preference`),n.Prefs.unregisterObserver(this._observerSymbols.get(d)),a.delete(d))};for(let d of Array.from(r.querySelectorAll("[preference]"))){let m=d.getAttribute("preference");r.querySelector("preferences > preference#"+m)&&(this.log("<preference> is deprecated -- `preference` attribute values should be full preference keys, not <preference> IDs"),m=(o=r.querySelector("preferences > preference#"+m))===null||o===void 0?void 0:o.getAttribute("name")),u(d,m),d.addEventListener(this.isXULElement(d)?"command":"input",f),c.setTimeout(()=>{h(d,m)})}new c.MutationObserver(d=>{for(let m of d)if(m.type=="attributes"){let g=m.target;p(g),g.hasAttribute("preference")&&(u(g,g.getAttribute("preference")||""),g.addEventListener(this.isXULElement(g)?"command":"input",f))}else if(m.type=="childList"){for(let g of Array.from(m.removedNodes))p(g);for(let g of Array.from(m.addedNodes))g.nodeType==c.Node.ELEMENT_NODE&&g.hasAttribute("preference")&&(u(g,g.getAttribute("preference")||""),g.addEventListener(this.isXULElement(g)?"command":"input",f))}}).observe(r,{childList:!0,subtree:!0,attributeFilter:["preference"]});for(let d of Array.from(r.querySelectorAll("[oncommand]")))d.oncommand=d.getAttribute("oncommand");for(let d of Array.from(r.children))d.dispatchEvent(new c.Event("load"))},i={onOpenWindow:r=>{if(!this.alive)return;let o=r.QueryInterface(Components.interfaces.nsIInterfaceRequestor).getInterface(Components.interfaces.nsIDOMWindow);o.addEventListener("load",async()=>{var a;if(o.location.href==="chrome://zotero/content/preferences/preferences.xul"){this.log("registerPrefPane:detected",e);let n=this.getGlobal("Zotero");e.id||(e.id=`plugin-${n.Utilities.randomString()}-${new Date().getTime()}`);let c=await n.File.getContentsAsync(e.src),l=typeof c=="string"?c:c.response,h=`<prefpane xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul" id="${e.id}" insertafter="zotero-prefpane-advanced" label="${e.label||e.pluginID}" image="${e.image||""}">
                ${l}
                </prefpane>`,f=this.ui.parseXHTMLToFragment(h,e.extraDTD,e.defaultXUL);this.log(f);let u=o.document.querySelector("prefwindow");u.appendChild(f);let p=o.document.querySelector(`#${e.id}`);u.addPane(p);let d=o.document.getAnonymousNodes(o.document.querySelector(`#${e.id}`))[0];d.style.overflowY="scroll",d.style.height="440px",o.sizeToContent(),d.scrollHeight===d.clientHeight&&(d.style.overflowY="hidden"),this.prefPaneCache.win=o,this.prefPaneCache.listeners[e.id]=i,t(p),!((a=e.scripts)===null||a===void 0)&&a.length&&e.scripts.forEach(m=>Services.scriptloader.loadSubScript(m,o)),e.onload&&e.onload(o)}},!1)},onCloseWindow:()=>{}};Services.wm.addListener(i)}unregister(e){var t;if(Object.keys(this.prefPaneCache.listeners).indexOf(e)<0)return!1;let r=this.prefPaneCache.listeners[e];Services.wm.removeListener(r),r.onOpenWindow=void 0;let o=this.prefPaneCache.win;return o&&!o.closed&&((t=o.document.querySelector(`#${e}`))===null||t===void 0||t.remove()),delete this.prefPaneCache.listeners[e],!0}unregisterAll(){this.alive=!1;for(let e in this.prefPaneCache.listeners)this.unregister(e)}};ue.PreferencePaneManager=Ge});var wt=v(B=>{"use strict";var zi=B&&B.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(B,"__esModule",{value:!0});B.ShortcutManager=void 0;var _=y(),Zi=C(),qi=y(),Si=zi(P()),We=class extends qi.ManagerTool{constructor(e){super(e),this.ui=new Zi.UITool(this),this.creatorId=`${Zotero.Utilities.randomString()}-${new Date().getTime()}`,this.initializeGlobal()}register(e,t){let i=t;switch(i.type=e,i.type){case"event":return this.registerEventKey(i),!0;case"element":return this.registerElementKey(i),!0;case"prefs":return this.getGlobal("Zotero").Prefs.set(i.id,i.key||""),!0;default:try{return i.register?i.register(i):!1}catch(r){return this.log(r),!1}}}getAll(){return Array.prototype.concat(this.getMainWindowElementKeys(),this.getEventKeys(),this.getPrefsKeys(),this.getBuiltinKeys())}checkKeyConflicting(e,t={includeEmpty:!1,customKeys:[]}){var i;e.modifiers=new q(e.modifiers||"").getRaw();let r=this.getAll();return!((i=t.customKeys)===null||i===void 0)&&i.length&&(r=r.concat(t.customKeys)),t.includeEmpty||(r=r.filter(o=>o.key)),r.filter(o=>{var a,n;return o.id!==e.id&&((a=o.key)===null||a===void 0?void 0:a.toLowerCase())===((n=e.key)===null||n===void 0?void 0:n.toLowerCase())&&o.modifiers===e.modifiers})}checkAllKeyConflicting(e={includeEmpty:!1,customKeys:[]}){var t;let i=this.getAll();!((t=e.customKeys)===null||t===void 0)&&t.length&&(i=i.concat(e.customKeys)),e.includeEmpty||(i=i.filter(o=>o.key));let r=[];for(;i.length>0;){let o=i.pop(),a=i.filter(n=>{var c,l;return((c=n.key)===null||c===void 0?void 0:c.toLowerCase())===((l=o.key)===null||l===void 0?void 0:l.toLowerCase())&&n.modifiers===o.modifiers});if(a.length){a.push(o),r.push(a);let n=a.map(l=>l.id),c=[];i.forEach((l,h)=>n.includes(l.id)&&c.push(h)),c.sort((l,h)=>h-l).forEach(l=>i.splice(l,1))}}return r}async unregister(e){var t;switch(e.type){case"element":return(t=(e.xulData.document||this.getGlobal("document")).querySelector(`#${e.id}`))===null||t===void 0||t.remove(),!0;case"prefs":return this.getGlobal("Zotero").Prefs.set(e.id,""),!0;case"builtin":return!1;case"event":let i=this.globalCache.eventKeys.findIndex(r=>r.id===e.id);for(;i>=0;)this.globalCache.eventKeys.splice(i,1),i=this.globalCache.eventKeys.findIndex(r=>r.id===e.id);return!0;default:try{return e.unregister?await e.unregister(e):!1}catch(r){return this.log(r),!1}}}unregisterAll(){this.ui.unregisterAll(),this.globalCache.eventKeys.filter(e=>e.creatorId===this.creatorId).forEach(e=>this.unregister(e))}initializeGlobal(){let e=this.getGlobal("Zotero"),t=this.getGlobal("window");this.globalCache=Si.default.getInstance().shortcut,this.globalCache._ready||(this.globalCache._ready=!0,t.addEventListener("keypress",i=>{let r=[],o=[];i.altKey&&(r.push("alt"),o.push("alt")),i.shiftKey&&(r.push("shift"),o.push("shift")),i.metaKey&&(r.push("meta"),e.isMac&&o.push("accel")),i.ctrlKey&&(r.push("control"),!e.isMac&&o.push("accel"));let a=new q(r.join(",")).getRaw(),n=new q(r.join(",")).getRaw();this.globalCache.eventKeys.forEach(c=>{var l;if(c.disabled)return;let h=new q(c.modifiers||"").getRaw();(h===a||h===n)&&((l=c.key)===null||l===void 0?void 0:l.toLowerCase())===i.key.toLowerCase()&&c.callback()})}))}registerEventKey(e){e.creatorId=this.creatorId,this.globalCache.eventKeys.push(e)}registerElementCommandset(e){var t;(t=e.document.querySelector("window"))===null||t===void 0||t.appendChild(this.ui.createElement(e.document,"commandset",{id:e.id,skipIfExists:!0,children:e.commands.map(i=>({tag:"command",id:i.id,attributes:{oncommand:i.oncommand,disabled:i.disabled,label:i.label}}))}))}registerElementCommand(e){var t;e._parentId&&this.registerElementCommandset({id:e._parentId,document:e.document,commands:[]}),(t=e.document.querySelector(`commandset#${e._parentId}`))===null||t===void 0||t.appendChild(this.ui.createElement(e.document,"command",{id:e.id,skipIfExists:!0,attributes:{oncommand:e.oncommand,disabled:e.disabled,label:e.label}}))}registerElementKeyset(e){var t;(t=e.document.querySelector("window"))===null||t===void 0||t.appendChild(this.ui.createElement(e.document,"keyset",{id:e.id,skipIfExists:!0,children:e.keys.map(i=>({tag:"key",id:i.id,attributes:{oncommand:i.xulData.oncommand||"//",command:i.xulData.command,modifiers:i.modifiers,key:this.getXULKey(i.key),keycode:this.getXULKeyCode(i.key),disabled:i.disabled}}))}))}registerElementKey(e){var t;let i=e.xulData.document||this.getGlobal("document");e.xulData._parentId&&this.registerElementKeyset({id:e.xulData._parentId,document:i,keys:[]}),(t=i.querySelector(`keyset#${e.xulData._parentId}`))===null||t===void 0||t.appendChild(this.ui.createElement(i,"key",{id:e.id,skipIfExists:!0,attributes:{oncommand:e.xulData.oncommand||"//",command:e.xulData.command,modifiers:e.modifiers,key:this.getXULKey(e.key),keycode:this.getXULKeyCode(e.key),disabled:e.disabled}})),e.xulData._commandOptions&&this.registerElementCommand(e.xulData._commandOptions)}getXULKey(e){if(e.length===1)return e}getXULKeyCode(e){let t=Object.values(N).findIndex(i=>i===e);if(t>=0)return Object.values(N)[t]}getStandardKey(e,t){return t&&Object.keys(N).includes(t)?N[t]:e}getElementCommandSets(e){return Array.from((e||this.getGlobal("document")).querySelectorAll("commandset")).map(t=>({id:t.id,commands:Array.from(t.querySelectorAll("command")).map(i=>({id:i.id,oncommand:i.getAttribute("oncommand"),disabled:i.getAttribute("disabled")==="true",label:i.getAttribute("label"),_parentId:t.id}))}))}getElementCommands(e){return Array.prototype.concat(...this.getElementCommandSets(e).map(t=>t.commands))}getElementKeySets(e){let t=this.getElementCommands(e);return Array.from((e||this.getGlobal("document")).querySelectorAll("keyset")).map(i=>({id:i.id,document:e,keys:Array.from(i.querySelectorAll("key")).map(r=>{let o=r.getAttribute("oncommand")||"",a=r.getAttribute("command")||"",n=t.find(l=>l.id===a);return{type:"element",id:r.id,key:this.getStandardKey(r.getAttribute("key")||"",r.getAttribute("keycode")||""),modifiers:new q(r.getAttribute("modifiers")||"").getRaw(),disabled:r.getAttribute("disabled")==="true",xulData:{document:e,oncommand:o,command:a,_parentId:i.id,_commandOptions:n},callback:()=>{let h=e.ownerGlobal.eval;h(o),h(n?.oncommand||"")}}})}))}getElementKeys(e){return Array.prototype.concat(...this.getElementKeySets(e).map(t=>t.keys)).filter(t=>!Fi.includes(t.id))}getMainWindowElementKeys(){return this.getElementKeys(this.getGlobal("document"))}getEventKeys(){return this.globalCache.eventKeys}getPrefsKeys(){let e=this.getGlobal("Zotero");return Vi.map(t=>({id:t.id,modifiers:t.modifiers,key:e.Prefs.get(t.id),callback:t.callback,type:"prefs"}))}getBuiltinKeys(){return Ai.map(e=>({id:e.id,modifiers:e.modifiers,key:e.key,callback:e.callback,type:"builtin"}))}};B.ShortcutManager=We;var q=class{constructor(e){e=e||"",this.accel=e.includes("accel"),this.shift=e.includes("shift"),this.control=e.includes("control"),this.meta=e.includes("meta"),this.alt=e.includes("alt")}equals(e){this.accel,e.accel,this.shift,e.shift,this.control,e.control,this.meta,e.meta,this.alt,e.alt}getRaw(){let e=[];return this.accel&&e.push("accel"),this.shift&&e.push("shift"),this.control&&e.push("control"),this.meta&&e.push("meta"),this.alt&&e.push("alt"),e.join(",")}},N;(function(s){s.VK_CANCEL="Unidentified",s.VK_BACK="Backspace",s.VK_TAB="Tab",s.VK_CLEAR="Clear",s.VK_RETURN="Enter",s.VK_ENTER="Enter",s.VK_SHIFT="Shift",s.VK_CONTROL="Control",s.VK_ALT="Alt",s.VK_PAUSE="Pause",s.VK_CAPS_LOCK="CapsLock",s.VK_ESCAPE="Escape",s.VK_SPACE=" ",s.VK_PAGE_UP="PageUp",s.VK_PAGE_DOWN="PageDown",s.VK_END="End",s.VK_HOME="Home",s.VK_LEFT="ArrowLeft",s.VK_UP="ArrowUp",s.VK_RIGHT="ArrowRight",s.VK_DOWN="ArrowDown",s.VK_PRINTSCREEN="PrintScreen",s.VK_INSERT="Insert",s.VK_DELETE="Backspace",s.VK_0="0",s.VK_1="1",s.VK_2="2",s.VK_3="3",s.VK_4="4",s.VK_5="5",s.VK_6="6",s.VK_7="7",s.VK_8="8",s.VK_9="9",s.VK_A="A",s.VK_B="B",s.VK_C="C",s.VK_D="D",s.VK_E="E",s.VK_F="F",s.VK_G="G",s.VK_H="H",s.VK_I="I",s.VK_J="J",s.VK_K="K",s.VK_L="L",s.VK_M="M",s.VK_N="N",s.VK_O="O",s.VK_P="P",s.VK_Q="Q",s.VK_R="R",s.VK_S="S",s.VK_T="T",s.VK_U="U",s.VK_V="V",s.VK_W="W",s.VK_X="X",s.VK_Y="Y",s.VK_Z="Z",s.VK_SEMICOLON="Unidentified",s.VK_EQUALS="Unidentified",s.VK_NUMPAD0="0",s.VK_NUMPAD1="1",s.VK_NUMPAD2="2",s.VK_NUMPAD3="3",s.VK_NUMPAD4="4",s.VK_NUMPAD5="5",s.VK_NUMPAD6="6",s.VK_NUMPAD7="7",s.VK_NUMPAD8="8",s.VK_NUMPAD9="9",s.VK_MULTIPLY="Multiply",s.VK_ADD="Add",s.VK_SEPARATOR="Separator",s.VK_SUBTRACT="Subtract",s.VK_DECIMAL="Decimal",s.VK_DIVIDE="Divide",s.VK_F1="F1",s.VK_F2="F2",s.VK_F3="F3",s.VK_F4="F4",s.VK_F5="F5",s.VK_F6="F6",s.VK_F7="F7",s.VK_F8="F8",s.VK_F9="F9",s.VK_F10="F10",s.VK_F11="F11",s.VK_F12="F12",s.VK_F13="F13",s.VK_F14="F14",s.VK_F15="F15",s.VK_F16="F16",s.VK_F17="F17",s.VK_F18="F18",s.VK_F19="F19",s.VK_F20="F20",s.VK_F21="Soft1",s.VK_F22="Soft2",s.VK_F23="Soft3",s.VK_F24="Soft4",s.VK_NUM_LOCK="NumLock",s.VK_SCROLL_LOCK="ScrollLock",s.VK_COMMA=",",s.VK_PERIOD=".",s.VK_SLASH="Divide",s.VK_BACK_QUOTE="`",s.VK_OPEN_BRACKET="[",s.VK_CLOSE_BRACKET="]",s.VK_QUOTE="\\",s.VK_HELP="Help"})(N||(N={}));function vt(s){return function(){var e;let t=_.BasicTool.getZotero().getMainWindow(),i=t.document.querySelector(`#${s}`);if(!i)return function(){};let r=t.eval;r(i.getAttribute("oncommand")||"//");let o=i.getAttribute("command");o&&r(((e=t.document.querySelector(`#${o}`))===null||e===void 0?void 0:e.getAttribute("oncommand"))||"//")}}function z(s){return function(){let e=_.BasicTool.getZotero();e.getActiveZoteroPane().handleKeyPress({metaKey:!0,ctrlKey:!0,shiftKey:!0,originalTarget:{id:""},preventDefault:()=>{},key:e.Prefs.get(`extensions.zotero.keys.${s}`,!0)})}}var Fi=["key_copyCitation","key_copyBibliography"],Vi=[{id:"extensions.zotero.keys.copySelectedItemCitationsToClipboard",modifiers:"accel,shift",elemId:"key_copyCitation",callback:vt("key_copyCitation")},{id:"extensions.zotero.keys.copySelectedItemsToClipboard",modifiers:"accel,shift",elemId:"key_copyBibliography",callback:vt("key_copyBibliography")},{id:"extensions.zotero.keys.library",modifiers:"accel,shift",callback:z("library")},{id:"extensions.zotero.keys.newItem",modifiers:"accel,shift",callback:z("newItem")},{id:"extensions.zotero.keys.newNote",modifiers:"accel,shift",callback:z("newNote")},{id:"extensions.zotero.keys.quicksearch",modifiers:"accel,shift",callback:z("quicksearch")},{id:"extensions.zotero.keys.saveToZotero",modifiers:"accel,shift",callback:z("saveToZotero")},{id:"extensions.zotero.keys.sync",modifiers:"accel,shift",callback:z("sync")},{id:"extensions.zotero.keys.toggleAllRead",modifiers:"accel,shift",callback:z("toggleAllRead")},{id:"extensions.zotero.keys.toggleRead",modifiers:"accel,shift",callback:z("toggleRead")}],Ai=[{id:"showItemCollection",modifiers:"",key:"Ctrl",callback:()=>{let s=_.BasicTool.getZotero(),e=s.getActiveZoteroPane();e.handleKeyUp({originalTarget:{id:e.itemsView?e.itemsView.id:""},keyCode:s.isWin?17:18})}},{id:"closeSelectedTab",modifiers:"accel",key:"W",callback:()=>{let s=_.BasicTool.getZotero().getMainWindow().Zotero_Tabs;s.selectedIndex>0&&s.close("")}},{id:"undoCloseTab",modifiers:"accel,shift",key:"T",callback:()=>{_.BasicTool.getZotero().getMainWindow().Zotero_Tabs.undoClose()}},{id:"selectNextTab",modifiers:"control",key:"Tab",callback:()=>{_.BasicTool.getZotero().getMainWindow().Zotero_Tabs.selectPrev()}},{id:"selectPreviousTab",modifiers:"control,shift",key:"Tab",callback:()=>{_.BasicTool.getZotero().getMainWindow().Zotero_Tabs.selectNext()}},{id:"selectTab1",modifiers:"accel",key:"1",callback:()=>{_.BasicTool.getZotero().getMainWindow().Zotero_Tabs.jump(0)}},{id:"selectTab2",modifiers:"accel",key:"2",callback:()=>{_.BasicTool.getZotero().getMainWindow().Zotero_Tabs.jump(1)}},{id:"selectTab3",modifiers:"accel",key:"3",callback:()=>{_.BasicTool.getZotero().getMainWindow().Zotero_Tabs.jump(2)}},{id:"selectTab4",modifiers:"accel",key:"4",callback:()=>{_.BasicTool.getZotero().getMainWindow().Zotero_Tabs.jump(3)}},{id:"selectTab5",modifiers:"accel",key:"5",callback:()=>{_.BasicTool.getZotero().getMainWindow().Zotero_Tabs.jump(4)}},{id:"selectTab6",modifiers:"accel",key:"6",callback:()=>{_.BasicTool.getZotero().getMainWindow().Zotero_Tabs.jump(5)}},{id:"selectTab7",modifiers:"accel",key:"7",callback:()=>{_.BasicTool.getZotero().getMainWindow().Zotero_Tabs.jump(6)}},{id:"selectTab8",modifiers:"accel",key:"8",callback:()=>{_.BasicTool.getZotero().getMainWindow().Zotero_Tabs.jump(7)}},{id:"selectTabLast",modifiers:"accel",key:"9",callback:()=>{_.BasicTool.getZotero().getMainWindow().Zotero_Tabs.selectLast()}}]});var kt=v(he=>{"use strict";Object.defineProperty(he,"__esModule",{value:!0});he.ClipboardHelper=void 0;var Ri=y(),$e=class extends Ri.BasicTool{constructor(){super(),this.filePath="",this.transferable=Components.classes["@mozilla.org/widget/transferable;1"].createInstance(Components.interfaces.nsITransferable),this.clipboardService=Components.classes["@mozilla.org/widget/clipboard;1"].getService(Components.interfaces.nsIClipboard),this.transferable.init(null)}addText(e,t="text/plain"){let i=Components.classes["@mozilla.org/supports-string;1"].createInstance(Components.interfaces.nsISupportsString);return i.data=e,this.isFX115()&&t==="text/unicode"&&(t="text/plain"),this.transferable.addDataFlavor(t),this.transferable.setTransferData(t,i,e.length*2),this}addImage(e){let t=e.split(",");if(!t[0].includes("base64"))return this;let i=t[0].match(/:(.*?);/)[1],r=this.getGlobal("window").atob(t[1]),o=r.length,a=new Uint8Array(o);for(;o--;)a[o]=r.charCodeAt(o);let n=Components.classes["@mozilla.org/image/tools;1"].getService(Components.interfaces.imgITools),c,l;return this.getGlobal("Zotero").platformMajorVersion>=102?(l=n.decodeImageFromArrayBuffer(a.buffer,i),c="application/x-moz-nativeimage"):(c="image/png",l=Components.classes["@mozilla.org/supports-interface-pointer;1"].createInstance(Components.interfaces.nsISupportsInterfacePointer),l.data=n.decodeImageFromArrayBuffer(a.buffer,c)),this.transferable.addDataFlavor(c),this.transferable.setTransferData(c,l,0),this}addFile(e){let t=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsIFile);return t.initWithPath(e),this.transferable.addDataFlavor("application/x-moz-file"),this.transferable.setTransferData("application/x-moz-file",t),this.filePath=e,this}copy(){try{this.clipboardService.setData(this.transferable,null,Components.interfaces.nsIClipboard.kGlobalClipboard)}catch(e){if(this.filePath&&Zotero.isMac)Zotero.Utilities.Internal.exec("/usr/bin/osascript",["-e",`set the clipboard to POSIX file "${this.filePath}"`]);else throw e}return this}};he.ClipboardHelper=$e});var _t=v(fe=>{"use strict";Object.defineProperty(fe,"__esModule",{value:!0});fe.FilePickerHelper=void 0;var Ki=y(),je=class extends Ki.BasicTool{constructor(e,t,i,r,o,a,n){super(),this.title=e,this.mode=t,this.filters=i,this.suggestion=r,this.directory=n,this.window=o,this.filterMask=a}async open(){let e;this.isFX115()?e=ChromeUtils.importESModule("chrome://zotero/content/modules/filePicker.mjs").FilePicker:e=this.getGlobal("require")("zotero/modules/filePicker").default;let t=new e;t.init(this.window||this.getGlobal("window"),this.title,this.getMode(t));for(let[r,o]of this.filters||[])t.appendFilter(r,o);switch(this.filterMask&&t.appendFilters(this.getFilterMask(t)),this.suggestion&&(t.defaultString=this.suggestion),this.directory&&(t.displayDirectory=this.directory),await t.show()){case t.returnOK:case t.returnReplace:return this.mode==="multiple"?t.files:t.file;default:return!1}}getMode(e){switch(this.mode){case"open":return e.modeOpen;case"save":return e.modeSave;case"folder":return e.modeGetFolder;case"multiple":return e.modeOpenMultiple;default:return 0}}getFilterMask(e){switch(this.filterMask){case"all":return e.filterAll;case"html":return e.filterHTML;case"text":return e.filterText;case"images":return e.filterImages;case"xml":return e.filterXML;case"apps":return e.filterApps;case"urls":return e.filterAllowURLs;case"audio":return e.filterAudio;case"video":return e.filterVideo;default:return 1}}};fe.FilePickerHelper=je});var xt=v(pe=>{"use strict";Object.defineProperty(pe,"__esModule",{value:!0});pe.ProgressWindowHelper=void 0;var Ni=y(),Oe=class extends Zotero.ProgressWindow{constructor(e,t={closeOnClick:!0,closeTime:5e3}){super(t),this.lines=[],this.closeTime=t.closeTime||5e3,this.changeHeadline(e),this.originalShow=this.show,this.show=this.showWithTimer,t.closeOtherProgressWindows&&Ni.BasicTool.getZotero().ProgressWindowSet.closeAll()}createLine(e){let t=this.getIcon(e.type,e.icon),i=new this.ItemProgress(t||"",e.text||"");return typeof e.progress=="number"&&i.setProgress(e.progress),this.lines.push(i),this.updateIcons(),this}changeLine(e){var t;if(((t=this.lines)===null||t===void 0?void 0:t.length)===0)return this;let i=typeof e.idx<"u"&&e.idx>=0&&e.idx<this.lines.length?e.idx:0,r=this.getIcon(e.type,e.icon);return r&&this.lines[i].setItemTypeAndIcon(r),e.text&&this.lines[i].setText(e.text),typeof e.progress=="number"&&this.lines[i].setProgress(e.progress),this.updateIcons(),this}showWithTimer(e=void 0){return this.originalShow(),typeof e<"u"&&(this.closeTime=e),this.closeTime&&this.closeTime>0&&this.startCloseTimer(this.closeTime),setTimeout(this.updateIcons.bind(this),50),this}static setIconURI(e,t){De[e]=t}getIcon(e,t){return e&&e in De?De[e]:t}updateIcons(){try{this.lines.forEach(e=>{let t=e._image,i=t.dataset.itemType;i&&i.startsWith("chrome://")&&!t.style.backgroundImage.includes("progress_arcs")&&(t.style.backgroundImage=`url(${t.dataset.itemType})`)})}catch{}}};pe.ProgressWindowHelper=Oe;var De={success:"chrome://zotero/skin/tick.png",fail:"chrome://zotero/skin/cross.png"}});var Tt=v(me=>{"use strict";Object.defineProperty(me,"__esModule",{value:!0});me.VirtualizedTableHelper=void 0;var Bi=y(),Je=class extends Bi.BasicTool{constructor(e){super(),this.window=e;let t=this.getGlobal("Zotero"),i=e.require;this.React=i("react"),this.ReactDOM=i("react-dom"),this.VirtualizedTable=i("components/virtualized-table"),this.IntlProvider=i("react-intl").IntlProvider,this.props={id:`${t.Utilities.randomString()}-${new Date().getTime()}`,getRowCount:()=>0},this.localeStrings=t.Intl.strings}setProp(...e){return e.length===1?Object.assign(this.props,e[0]):e.length===2&&(this.props[e[0]]=e[1]),this}setLocale(e){return Object.assign(this.localeStrings,e),this}setContainerId(e){return this.containerId=e,this}render(e,t,i){let r=()=>{this.treeInstance.invalidate(),typeof e<"u"&&e>=0?this.treeInstance.selection.select(e):this.treeInstance.selection.clearSelection()};if(this.treeInstance)r();else{let o=Object.assign({},this.props,{ref:c=>this.treeInstance=c});o.getRowData&&!o.renderItem&&Object.assign(o,{renderItem:this.VirtualizedTable.makeRowRenderer(o.getRowData)});let a=this.React.createElement(this.IntlProvider,{locale:Zotero.locale,messages:Zotero.Intl.strings},this.React.createElement(this.VirtualizedTable,o)),n=this.window.document.getElementById(this.containerId);new Promise(c=>this.ReactDOM.render(a,n,c)).then(()=>{this.getGlobal("setTimeout")(()=>{r()})}).then(t,i)}return this}};me.VirtualizedTableHelper=Je});var Ct=v(ge=>{"use strict";Object.defineProperty(ge,"__esModule",{value:!0});ge.DialogHelper=void 0;var Mi=C(),Qe=class extends Mi.UITool{constructor(e,t){if(super(),e<=0||t<=0)throw Error("row and column must be positive integers.");this.elementProps={tag:"vbox",attributes:{flex:1},styles:{width:"100%",height:"100%"},children:[]};for(let i=0;i<Math.max(e,1);i++){this.elementProps.children.push({tag:"hbox",attributes:{flex:1},children:[]});for(let r=0;r<Math.max(t,1);r++)this.elementProps.children[i].children.push({tag:"vbox",attributes:{flex:1},children:[]})}this.elementProps.children.push({tag:"hbox",attributes:{flex:0,pack:"end"},children:[]}),this.dialogData={}}addCell(e,t,i,r=!0){if(e>=this.elementProps.children.length||t>=this.elementProps.children[e].children.length)throw Error(`Cell index (${e}, ${t}) is invalid, maximum (${this.elementProps.children.length}, ${this.elementProps.children[0].children.length})`);return this.elementProps.children[e].children[t].children=[i],this.elementProps.children[e].children[t].attributes.flex=r?1:0,this}addButton(e,t,i={}){return t=t||`${Zotero.Utilities.randomString()}-${new Date().getTime()}`,this.elementProps.children[this.elementProps.children.length-1].children.push({tag:"vbox",styles:{margin:"10px"},children:[{tag:"button",namespace:"html",id:t,attributes:{type:"button","data-l10n-id":e},properties:{innerHTML:e},listeners:[{type:"click",listener:r=>{this.dialogData._lastButtonId=t,i.callback&&i.callback(r),i.noClose||this.window.close()}}]}]}),this}setDialogData(e){return this.dialogData=e,this}open(e,t={centerscreen:!0,resizable:!0,fitContent:!0}){return this.window=Hi(this,`${Zotero.Utilities.randomString()}-${new Date().getTime()}`,e,this.elementProps,this.dialogData,t),this}};ge.DialogHelper=Qe;function Hi(s,e,t,i,r,o={centerscreen:!0,resizable:!0,fitContent:!0}){var a,n,c;let l=s.getGlobal("Zotero");r=r||{},r.loadLock||(r.loadLock=l.Promise.defer()),r.unloadLock||(r.unloadLock=l.Promise.defer());let h=`resizable=${o.resizable?"yes":"no"},`;(o.width||o.height)&&(h+=`width=${o.width||100},height=${o.height||100},`),o.left&&(h+=`left=${o.left},`),o.top&&(h+=`top=${o.top},`),o.centerscreen&&(h+="centerscreen,"),o.noDialogMode&&(h+="dialog=no,"),o.alwaysRaised&&(h+="alwaysRaised=yes,");let f=s.getGlobal("openDialog")("about:blank",e||"_blank",h,r);return(a=r.loadLock)===null||a===void 0||a.promise.then(()=>{f.document.head.appendChild(s.createElement(f.document,"title",{properties:{innerText:t},attributes:{"data-l10n-id":t}}));let u=r.l10nFiles||[];typeof u=="string"&&(u=[u]),u.forEach(p=>{f.document.head.appendChild(s.createElement(f.document,"link",{properties:{rel:"localization",href:p}}))}),s.appendElement({tag:"fragment",children:[{tag:"style",properties:{innerHTML:Ei}},{tag:"link",properties:{rel:"stylesheet",href:"chrome://zotero-platform/content/zotero.css"}}]},f.document.head),It(i,s),f.document.body.appendChild(s.createElement(f.document,"fragment",{children:[i]})),Array.from(f.document.querySelectorAll("*[data-bind]")).forEach(p=>{let d=p.getAttribute("data-bind"),m=p.getAttribute("data-attr"),g=p.getAttribute("data-prop");d&&r&&r[d]&&(g?p[g]=r[d]:p.setAttribute(m||"value",r[d]))}),o.fitContent&&setTimeout(()=>{f.sizeToContent()},300),f.focus()}).then(()=>{r?.loadCallback&&r.loadCallback()}),r.unloadLock.promise.then(()=>{r?.unloadCallback&&r.unloadCallback()}),f.addEventListener("DOMContentLoaded",function u(p){var d,m;(m=(d=f.arguments[0])===null||d===void 0?void 0:d.loadLock)===null||m===void 0||m.resolve(),f.removeEventListener("DOMContentLoaded",u,!1)},!1),f.addEventListener("beforeunload",function u(p){Array.from(f.document.querySelectorAll("*[data-bind]")).forEach(d=>{let m=this.window.arguments[0],g=d.getAttribute("data-bind"),b=d.getAttribute("data-attr"),w=d.getAttribute("data-prop");g&&m&&(w?m[g]=d[w]:m[g]=d.getAttribute(b||"value"))}),this.window.removeEventListener("beforeunload",u,!1),r?.beforeUnloadCallback&&r.beforeUnloadCallback()}),f.addEventListener("unload",function u(p){var d,m,g;!((d=this.window.arguments[0])===null||d===void 0)&&d.loadLock.promise.isPending()||((g=(m=this.window.arguments[0])===null||m===void 0?void 0:m.unloadLock)===null||g===void 0||g.resolve(),this.window.removeEventListener("unload",u,!1))}),f.document.readyState==="complete"&&((c=(n=f.arguments[0])===null||n===void 0?void 0:n.loadLock)===null||c===void 0||c.resolve()),f}function It(s,e){var t,i,r,o,a,n,c;let l=!0;if(s.tag==="select"&&e.isZotero7()){l=!1;let h={tag:"div",classList:["dropdown"],listeners:[{type:"mouseleave",listener:f=>{let u=f.target.querySelector("select");u?.blur()}}],children:[Object.assign({},s,{tag:"select",listeners:[{type:"focus",listener:f=>{var u;let p=f.target,d=(u=p.parentElement)===null||u===void 0?void 0:u.querySelector(".dropdown-content");d&&(d.style.display="block"),p.setAttribute("focus","true")}},{type:"blur",listener:f=>{var u;let p=f.target,d=(u=p.parentElement)===null||u===void 0?void 0:u.querySelector(".dropdown-content");d&&(d.style.display="none"),p.removeAttribute("focus")}}]}),{tag:"div",classList:["dropdown-content"],children:(t=s.children)===null||t===void 0?void 0:t.map(f=>{var u,p,d;return{tag:"p",attributes:{value:(u=f.properties)===null||u===void 0?void 0:u.value},properties:{innerHTML:((p=f.properties)===null||p===void 0?void 0:p.innerHTML)||((d=f.properties)===null||d===void 0?void 0:d.innerText)},classList:["dropdown-item"],listeners:[{type:"click",listener:m=>{var g;let b=(g=m.target.parentElement)===null||g===void 0?void 0:g.previousElementSibling;b&&(b.value=m.target.getAttribute("value")||""),b?.blur()}}]}})}]};for(let f in s)delete s[f];Object.assign(s,h)}else if(s.tag==="a"){let h=((i=s?.properties)===null||i===void 0?void 0:i.href)||"";(r=s.properties)!==null&&r!==void 0||(s.properties={}),s.properties.href="javascript:void(0);",(o=s.attributes)!==null&&o!==void 0||(s.attributes={}),s.attributes["zotero-href"]=h,(a=s.listeners)!==null&&a!==void 0||(s.listeners=[]),s.listeners.push({type:"click",listener:f=>{var u;let p=(u=f.target)===null||u===void 0?void 0:u.getAttribute("zotero-href");p&&e.getGlobal("Zotero").launchURL(p)}}),(n=s.classList)!==null&&n!==void 0||(s.classList=[]),s.classList.push("zotero-text-link")}l&&((c=s.children)===null||c===void 0||c.forEach(h=>It(h,e)))}var Ei=`
.zotero-text-link {
  -moz-user-focus: normal;
  color: -moz-nativehyperlinktext;
  text-decoration: underline;
  border: 1px solid transparent;
  cursor: pointer;
}
.dropdown {
  position: relative;
  display: inline-block;
}
.dropdown-content {
  display: none;
  position: absolute;
  background-color: var(--material-toolbar);
  min-width: 160px;
  box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 0.5);
  border-radius: 5px;
  padding: 5px 0 5px 0;
  z-index: 999;
}
.dropdown-item {
  margin: 0px;
  padding: 5px 10px 5px 10px;
}
.dropdown-item:hover {
  background-color: var(--fill-quinary);
}
`});var Pt=v(M=>{"use strict";var Gi=M&&M.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(M,"__esModule",{value:!0});M.ReaderInstanceManager=void 0;var Wi=y(),$i=Gi(P()),Ue=class extends Wi.ManagerTool{constructor(e){super(e),this.cachedHookIds=[],this.initializeGlobal()}register(e,t,i){let r=this.getGlobal("Zotero");switch(e){case"initialized":this.globalCache.initializedHooks[t]=i,r.Reader._readers.forEach(i);break;default:break}this.cachedHookIds.push(t)}unregister(e){delete this.globalCache.initializedHooks[e]}unregisterAll(){this.cachedHookIds.forEach(e=>this.unregister(e))}initializeGlobal(){if(this.globalCache=$i.default.getInstance().readerInstance,!this.globalCache._ready){this.globalCache._ready=!0;let e=this.getGlobal("Zotero"),t=this;e.Reader._readers=new(this.getGlobal("Proxy"))(e.Reader._readers,{set(i,r,o,a){return i[r]=o,isNaN(Number(r))||Object.values(t.globalCache.initializedHooks).forEach(n=>{try{n(o)}catch(c){t.log(c)}}),!0}})}}};M.ReaderInstanceManager=Ue});var Lt=v(H=>{"use strict";var ji=H&&H.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(H,"__esModule",{value:!0});H.ItemBoxManager=void 0;var Di=y(),Oi=oe(),Ji=Re(),Qi=ji(P()),Xe=class extends Di.ManagerTool{constructor(e){super(e),this.initializationLock=this.getGlobal("Zotero").Promise.defer(),this.localCache=[],this.fieldHooks=new Oi.FieldHookManager,this.patcherManager=new Ji.PatcherManager,this.initializeGlobal()}async register(e,t,i,r={}){this.fieldHooks.register("isFieldOfBase",e,()=>!1),i&&this.fieldHooks.register("getField",e,i),r.editable&&r.setFieldHook&&this.fieldHooks.register("setField",e,r.setFieldHook),this.globalCache.fieldOptions[e]={field:e,displayName:t,editable:r.editable||!1,index:r.index||-1,multiline:r.multiline||!1,collapsible:r.collapsible||!1},this.localCache.push(e),await this.initializationLock.promise,this.refresh()}unregister(e,t={}){delete this.globalCache.fieldOptions[e],t.skipIsFieldOfBase||this.fieldHooks.unregister("isFieldOfBase",e),t.skipGetField||this.fieldHooks.unregister("getField",e),t.skipSetField||this.fieldHooks.unregister("setField",e);let i=this.localCache.indexOf(e);i>-1&&this.localCache.splice(i,1),t.skipRefresh||this.refresh()}unregisterAll(){[...this.localCache].forEach(e=>this.unregister(e,{skipGetField:!0,skipSetField:!0,skipIsFieldOfBase:!0,skipRefresh:!0})),this.fieldHooks.unregisterAll(),this.refresh()}refresh(){try{Array.from(this.getGlobal("document").querySelectorAll(this.isZotero7()?"item-box":"zoteroitembox")).forEach(e=>e.refresh())}catch(e){this.log(e)}}async initializeGlobal(){let e=this.getGlobal("Zotero");await e.uiReadyPromise;let t=this.getGlobal("window");this.globalCache=Qi.default.getInstance().itemBox;let i=this.globalCache,r=this.isZotero7();if(!i._ready){i._ready=!0;let o;if(r)o=new(this.getGlobal("customElements").get("item-box"));else{o=t.document.querySelector("#zotero-editpane-item-box");let a=5e3,n=0;for(;!o&&n<a;)o=t.document.querySelector("#zotero-editpane-item-box"),await e.Promise.delay(10),n+=10;if(!o){i._ready=!1,this.log("ItemBox initialization failed");return}}this.patcherManager.register(o.__proto__,"refresh",a=>function(){let n=this;a.apply(n,arguments);for(let c of Object.values(i.fieldOptions)){let l=document.createElement(r?"th":"label");l.setAttribute("fieldname",c.field);let h=`extensions.zotero.pluginToolkit.fieldCollapsed.${c.field}`,f=c.multiline&&c.collapsible&&e.Prefs.get(h,!0),u=c.displayName;if(f&&(u=`(...)${u}`),r){let b=document.createElement("label");b.className="key",b.textContent=u,l.appendChild(b)}else l.setAttribute("value",u);let p=n.clickable;n.clickable=c.editable;let d=n.createValueElement(n.item.getField(c.field),c.field,1099);n.clickable=p,c.multiline&&!e.Prefs.get(h,!0)?d.classList.add("multiline"):r||(d.setAttribute("crop","end"),d.setAttribute("value",d.innerHTML),d.innerHTML=""),c.collapsible&&l.addEventListener("click",function(b){e.Prefs.set(h,!e.Prefs.get(h,!0),!0),n.refresh()}),l.addEventListener("click",r?function(b){var w;let k=(w=b.currentTarget.nextElementSibling)===null||w===void 0?void 0:w.querySelector("input, textarea");k&&k.blur()}:function(b){var w;let k=(w=b.currentTarget.nextElementSibling)===null||w===void 0?void 0:w.inputField;k&&k.blur()});let m=r?n._infoTable:n._dynamicFields,g=c.index;g===0&&(g=1),g&&g>=0&&g<m.children.length?(n._beforeRow=m.children[g],n.addDynamicRow(l,d,!0)):n.addDynamicRow(l,d)}})}this.initializationLock.resolve()}};H.ItemBoxManager=Xe});var Zt=v(be=>{"use strict";Object.defineProperty(be,"__esModule",{value:!0});be.LargePrefHelper=void 0;var Ui=y(),Ye=class extends Ui.BasicTool{constructor(e,t,i="default"){super(),this.keyPref=e,this.valuePrefPrefix=t,i==="default"?this.hooks=zt:i==="parser"?this.hooks=Xi:this.hooks=Object.assign(Object.assign({},zt),i),this.innerObj={}}asObject(){return this.constructTempObj()}asMapLike(){let e={get:t=>this.getValue(t),set:(t,i)=>(this.setValue(t,i),e),has:t=>this.hasKey(t),delete:t=>this.deleteKey(t),clear:()=>{for(let t of this.getKeys())this.deleteKey(t)},forEach:t=>this.constructTempMap().forEach(t),get size(){return this._this.getKeys().length},entries:()=>this.constructTempMap().values(),keys:()=>this.getKeys()[Symbol.iterator](),values:()=>this.constructTempMap().values(),[Symbol.iterator]:()=>this.constructTempMap()[Symbol.iterator](),[Symbol.toStringTag]:"MapLike",_this:this};return e}getKeys(){let e=Zotero.Prefs.get(this.keyPref,!0),t=e?JSON.parse(e):[];for(let i of t){let r="placeholder";this.innerObj[i]=r}return t}setKeys(e){e=[...new Set(e.filter(t=>t))],Zotero.Prefs.set(this.keyPref,JSON.stringify(e),!0);for(let t of e){let i="placeholder";this.innerObj[t]=i}}getValue(e){let t=Zotero.Prefs.get(`${this.valuePrefPrefix}${e}`,!0);if(typeof t>"u")return;let{value:i}=this.hooks.afterGetValue({value:t});return this.innerObj[e]=i,i}setValue(e,t){let{key:i,value:r}=this.hooks.beforeSetValue({key:e,value:t});this.setKey(i),Zotero.Prefs.set(`${this.valuePrefPrefix}${i}`,r,!0),this.innerObj[i]=r}hasKey(e){return this.getKeys().includes(e)}setKey(e){let t=this.getKeys();t.includes(e)||(t.push(e),this.setKeys(t))}deleteKey(e){let t=this.getKeys(),i=t.indexOf(e);return i>-1&&(t.splice(i,1),delete this.innerObj[e],this.setKeys(t)),Zotero.Prefs.clear(`${this.valuePrefPrefix}${e}`,!0),!0}constructTempObj(){return new Proxy(this.innerObj,{get:(e,t,i)=>(this.getKeys(),typeof t=="string"&&t in e&&this.getValue(t),Reflect.get(e,t,i)),set:(e,t,i,r)=>typeof t=="string"?i===void 0?(this.deleteKey(t),!0):(this.setValue(t,i),!0):Reflect.set(e,t,i,r),has:(e,t)=>(this.getKeys(),Reflect.has(e,t)),deleteProperty:(e,t)=>typeof t=="string"?(this.deleteKey(t),!0):Reflect.deleteProperty(e,t)})}constructTempMap(){let e=new Map;for(let t of this.getKeys())e.set(t,this.getValue(t));return e}};be.LargePrefHelper=Ye;var zt={afterGetValue:({value:s})=>({value:s}),beforeSetValue:({key:s,value:e})=>({key:s,value:e})},Xi={afterGetValue:({value:s})=>{try{s=JSON.parse(s)}catch{return{value:s}}return{value:s}},beforeSetValue:({key:s,value:e})=>(e=JSON.stringify(e),{key:s,value:e})}});var qt=v(G=>{"use strict";Object.defineProperty(G,"__esModule",{value:!0});G.KeyModifier=G.KeyboardManager=void 0;var Yi=y(),er=Pe(),et=class extends Yi.ManagerTool{constructor(e){super(e),this._keyboardCallbacks=new Set,this.initKeyboardListener=this._initKeyboardListener.bind(this),this.unInitKeyboardListener=this._unInitKeyboardListener.bind(this),this.triggerKeydown=t=>{this._cachedKey?this._cachedKey.merge(new E(t),{allowOverwrite:!1}):this._cachedKey=new E(t),this.dispatchCallback(t,{type:"keydown"})},this.triggerKeyup=async t=>{if(!this._cachedKey)return;let i=new E(this._cachedKey);this._cachedKey=void 0,this.dispatchCallback(t,{keyboard:i,type:"keyup"})},this.id=Zotero.Utilities.randomString(),this._ensureAutoUnregisterAll(),this.addListenerCallback("onMainWindowLoad",this.initKeyboardListener),this.addListenerCallback("onMainWindowUnload",this.unInitKeyboardListener),this.initReaderKeyboardListener();for(let t of Zotero.getMainWindows())this.initKeyboardListener(t)}register(e){this._keyboardCallbacks.add(e)}unregister(e){this._keyboardCallbacks.delete(e)}unregisterAll(){this._keyboardCallbacks.clear(),this.removeListenerCallback("onMainWindowLoad",this.initKeyboardListener),this.removeListenerCallback("onMainWindowUnload",this.unInitKeyboardListener);for(let e of Zotero.getMainWindows())this.unInitKeyboardListener(e)}initReaderKeyboardListener(){Zotero.Reader.registerEventListener("renderToolbar",e=>this.addReaderKeyboardCallback(e),this._basicOptions.api.pluginID),Zotero.Reader._readers.forEach(e=>this.addReaderKeyboardCallback({reader:e}))}addReaderKeyboardCallback(e){let t=e.reader,i=`_ztoolkitKeyboard${this.id}Initialized`;t._iframeWindow[i]||(this._initKeyboardListener(t._iframeWindow),(0,er.waitUntil)(()=>{var r,o;return!Components.utils.isDeadWrapper(t._internalReader)&&((o=(r=t._internalReader)===null||r===void 0?void 0:r._primaryView)===null||o===void 0?void 0:o._iframeWindow)},()=>{var r;return this._initKeyboardListener((r=t._internalReader._primaryView)===null||r===void 0?void 0:r._iframeWindow)}),t._iframeWindow[i]=!0)}_initKeyboardListener(e){e&&(e.addEventListener("keydown",this.triggerKeydown),e.addEventListener("keyup",this.triggerKeyup))}_unInitKeyboardListener(e){e&&(e.removeEventListener("keydown",this.triggerKeydown),e.removeEventListener("keyup",this.triggerKeyup))}dispatchCallback(...e){this._keyboardCallbacks.forEach(t=>t(...e))}};G.KeyboardManager=et;var E=class s{constructor(e,t){this.accel=!1,this.shift=!1,this.control=!1,this.meta=!1,this.alt=!1,this.key="",this.useAccel=!1,this.useAccel=t?.useAccel||!1,!(typeof e>"u")&&(typeof e=="string"?(e=e||"",e=this.unLocalized(e),this.accel=e.includes("accel"),this.shift=e.includes("shift"),this.control=e.includes("control"),this.meta=e.includes("meta"),this.alt=e.includes("alt"),this.key=e.replace(/(accel|shift|control|meta|alt| |,|-)/g,"").toLocaleLowerCase()):e instanceof s?this.merge(e,{allowOverwrite:!0}):(t?.useAccel&&(Zotero.isMac?this.accel=e.metaKey:this.accel=e.ctrlKey),this.shift=e.shiftKey,this.control=e.ctrlKey,this.meta=e.metaKey,this.alt=e.altKey,["Shift","Meta","Ctrl","Alt","Control"].includes(e.key)||(this.key=e.key)))}merge(e,t){let i=t?.allowOverwrite||!1;return this.mergeAttribute("accel",e.accel,i),this.mergeAttribute("shift",e.shift,i),this.mergeAttribute("control",e.control,i),this.mergeAttribute("meta",e.meta,i),this.mergeAttribute("alt",e.alt,i),this.mergeAttribute("key",e.key,i),this}equals(e){if(typeof e=="string"&&(e=new s(e)),this.shift!==e.shift||this.alt!==e.alt||this.key.toLowerCase()!==e.key.toLowerCase())return!1;if(this.accel||e.accel){if(Zotero.isMac){if((this.accel||this.meta)!==(e.accel||e.meta)||this.control!==e.control)return!1}else if((this.accel||this.control)!==(e.accel||e.control)||this.meta!==e.meta)return!1}else if(this.control!==e.control||this.meta!==e.meta)return!1;return!0}getRaw(){let e=[];return this.accel&&e.push("accel"),this.shift&&e.push("shift"),this.control&&e.push("control"),this.meta&&e.push("meta"),this.alt&&e.push("alt"),this.key&&e.push(this.key),e.join(",")}getLocalized(){let e=this.getRaw();return Zotero.isMac?e.replaceAll("control","\u2303").replaceAll("alt","\u2325").replaceAll("shift","\u21E7").replaceAll("meta","\u2318"):e.replaceAll("control","Ctrl").replaceAll("alt","Alt").replaceAll("shift","Shift").replaceAll("meta","Win")}unLocalized(e){return Zotero.isMac?e.replaceAll("\u2303","control").replaceAll("\u2325","alt").replaceAll("\u21E7","shift").replaceAll("\u2318","meta"):e.replaceAll("Ctrl","control").replaceAll("Alt","alt").replaceAll("Shift","shift").replaceAll("Win","meta")}mergeAttribute(e,t,i){(i||!this[e])&&(this[e]=t)}};G.KeyModifier=E});var St=v(ve=>{"use strict";Object.defineProperty(ve,"__esModule",{value:!0});ve.GuideHelper=void 0;var tr=y(),tt=class extends tr.BasicTool{constructor(){super(),this._steps=[]}addStep(e){return this._steps.push(e),this}addSteps(e){return this._steps.push(...e),this}async show(e){if(!e?.ownerGlobal)throw new Error("Document is required.");let t=new ye(e.ownerGlobal);return await t.show(this._steps),await new Promise(r=>{t._panel.addEventListener("guide-finished",()=>r(t))}),t}async highlight(e,t){if(!e?.ownerGlobal)throw new Error("Document is required.");let i=new ye(e.ownerGlobal);return await i.show([t]),await new Promise(o=>{i._panel.addEventListener("guide-finished",()=>o(i))}),i}};ve.GuideHelper=tt;var ye=class{get content(){return this._window.MozXULElement.parseXULToFragment(`
      <panel id="${this._id}" class="guide-panel" type="arrow" align="top" noautohide="true">
          <html:div class="guide-panel-content">
              <html:div class="guide-panel-header"></html:div>
              <html:div class="guide-panel-body"></html:div>
              <html:div class="guide-panel-footer">
                  <html:div class="guide-panel-progress"></html:div>
                  <html:div class="guide-panel-buttons">
                      <button id="prev-button" class="guide-panel-button" hidden="true"></button>
                      <button id="next-button" class="guide-panel-button" hidden="true"></button>
                      <button id="close-button" class="guide-panel-button" hidden="true"></button>
                  </html:div>
              </html:div>
          </html:div>
          <html:style>
              .guide-panel {
                  background-color: var(--material-menu);
                  color: var(--fill-primary);
              }
              .guide-panel-content {
                  display: flex;
                  flex-direction: column;
                  padding: 0;
              }
              .guide-panel-header {
                  font-size: 1.2em;
                  font-weight: bold;
                  margin-bottom: 10px;
              }
              .guide-panel-header:empty {
                display: none;
              }
              .guide-panel-body {
                  align-items: center;
                  display: flex;
                  flex-direction: column;
                  white-space: pre-wrap;
              }
              .guide-panel-body:empty {
                display: none;
              }
              .guide-panel-footer {
                  display: flex;
                  flex-direction: row;
                  align-items: center;
                  justify-content: space-between;
                  margin-top: 10px;
              }
              .guide-panel-progress {
                  font-size: 0.8em;
              }
              .guide-panel-buttons {
                  display: flex;
                  flex-direction: row;
                  flex-grow: 1;
                  justify-content: flex-end;
              }
          </html:style>
      </panel>
  `)}get currentStep(){if(this._steps)return this._steps[this._currentIndex]}get currentTarget(){let e=this.currentStep;if(!e?.element)return;let t;return typeof e.element=="function"?t=e.element():typeof e.element=="string"?t=document.querySelector(e.element):e.element?t=e.element:t=document.documentElement,t}get hasNext(){return this._steps&&this._currentIndex<this._steps.length-1}get hasPrevious(){return this._steps&&this._currentIndex>0}get hookProps(){return{config:this.currentStep,state:{step:this._currentIndex,steps:this._steps,controller:this}}}get panel(){return this._panel}constructor(e){this._id=`guide-${Zotero.Utilities.randomString()}`,this._cachedMasks=[],this._centerPanel=()=>{let r=this._window;this._panel.moveTo(r.screenX+r.innerWidth/2-this._panel.clientWidth/2,r.screenY+r.innerHeight/2-this._panel.clientHeight/2)},this._window=e,this._noClose=!1,this._closed=!1,this._autoNext=!0,this._currentIndex=0;let t=e.document,i=this.content;i&&t.documentElement.append(t.importNode(i,!0)),this._panel=t.querySelector(`#${this._id}`),this._header=this._panel.querySelector(".guide-panel-header"),this._body=this._panel.querySelector(".guide-panel-body"),this._footer=this._panel.querySelector(".guide-panel-footer"),this._progress=this._panel.querySelector(".guide-panel-progress"),this._closeButton=this._panel.querySelector("#close-button"),this._prevButton=this._panel.querySelector("#prev-button"),this._nextButton=this._panel.querySelector("#next-button"),this._closeButton.addEventListener("click",async()=>{var r;!((r=this.currentStep)===null||r===void 0)&&r.onCloseClick&&await this.currentStep.onCloseClick(this.hookProps),this.abort()}),this._prevButton.addEventListener("click",async()=>{var r;!((r=this.currentStep)===null||r===void 0)&&r.onPrevClick&&await this.currentStep.onPrevClick(this.hookProps),this.movePrevious()}),this._nextButton.addEventListener("click",async()=>{var r;!((r=this.currentStep)===null||r===void 0)&&r.onNextClick&&await this.currentStep.onNextClick(this.hookProps),this.moveNext()}),this._panel.addEventListener("popupshown",this._handleShown.bind(this)),this._panel.addEventListener("popuphidden",this._handleHidden.bind(this)),this._window.addEventListener("resize",this._centerPanel)}async show(e){e&&(this._steps=e,this._currentIndex=0);let t=this._currentIndex;this._noClose=!1,this._closed=!1,this._autoNext=!0;let i=this.currentStep;if(!i)return;let r=this.currentTarget;if(i.onBeforeRender&&(await i.onBeforeRender(this.hookProps),t!==this._currentIndex)){await this.show();return}i.onMask?i.onMask({mask:c=>this._createMask(c)}):this._createMask(r);let o,a=0,n=i.position||"after_start";n==="center"&&(n="overlap",o=window.innerWidth/2,a=window.innerHeight/2),this._panel.openPopup(r,i.position||"after_start",o,a,!1,!1)}hide(){this._panel.hidePopup()}abort(){this._closed=!0,this.hide(),this._steps=void 0}moveTo(e){if(!this._steps){this.hide();return}if(e<0&&(e=0),!this._steps[e]){this._currentIndex=this._steps.length,this.hide();return}this._autoNext=!1,this._noClose=!0,this.hide(),this._noClose=!1,this._autoNext=!0,this._currentIndex=e,this.show()}moveNext(){this.moveTo(this._currentIndex+1)}movePrevious(){this.moveTo(this._currentIndex-1)}_handleShown(){if(!this._steps)return;let e=this.currentStep;if(!e)return;this._header.innerHTML=e.title||"",this._body.innerHTML=e.description||"",this._panel.querySelectorAll(".guide-panel-button").forEach(i=>{i.hidden=!0,i.disabled=!1});let t=e.showButtons;t||(t=[],this.hasPrevious&&t.push("prev"),this.hasNext?t.push("next"):t.push("close")),t?.length&&t.forEach(i=>{this._panel.querySelector(`#${i}-button`).hidden=!1}),e.disableButtons&&e.disableButtons.forEach(i=>{this._panel.querySelector(`#${i}-button`).disabled=!0}),e.showProgress?(this._progress.hidden=!1,this._progress.textContent=e.progressText||`${this._currentIndex+1}/${this._steps.length}`):this._progress.hidden=!0,this._closeButton.label=e.closeBtnText||"Done",this._nextButton.label=e.nextBtnText||"Next",this._prevButton.label=e.prevBtnText||"Previous",e.onRender&&e.onRender(this.hookProps),e.position==="center"&&(this._centerPanel(),this._window.setTimeout(this._centerPanel,10))}async _handleHidden(){if(this._removeMask(),this._header.innerHTML="",this._body.innerHTML="",this._progress.textContent="",!this._steps)return;let e=this.currentStep;if(e&&e.onExit&&await e.onExit(this.hookProps),!this._noClose&&(this._closed||!this.hasNext)){this._panel.dispatchEvent(new this._window.CustomEvent("guide-finished")),this._panel.remove(),this._window.removeEventListener("resize",this._centerPanel);return}this._autoNext&&this.moveNext()}_createMask(e){let t=e?.ownerDocument||this._window.document,i="http://www.w3.org/2000/svg",r=t.createElementNS(i,"svg");r.id="guide-panel-mask",r.style.position="fixed",r.style.top="0",r.style.left="0",r.style.width="100%",r.style.height="100%",r.style.zIndex="9999";let o=t.createElementNS(i,"mask");o.id="mask";let a=t.createElementNS(i,"rect");if(a.setAttribute("x","0"),a.setAttribute("y","0"),a.setAttribute("width","100%"),a.setAttribute("height","100%"),a.setAttribute("fill","white"),o.appendChild(a),e){let c=e.getBoundingClientRect(),l=t.createElementNS(i,"rect");l.setAttribute("x",c.left.toString()),l.setAttribute("y",c.top.toString()),l.setAttribute("width",c.width.toString()),l.setAttribute("height",c.height.toString()),l.setAttribute("fill","black"),o.appendChild(l)}let n=t.createElementNS(i,"rect");n.setAttribute("x","0"),n.setAttribute("y","0"),n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("mask","url(#mask)"),n.setAttribute("opacity","0.7"),r.appendChild(o),r.appendChild(n),this._cachedMasks.push(new WeakRef(r)),t.documentElement.appendChild(r)}_removeMask(){this._cachedMasks.forEach(e=>{let t=e.deref();t&&t.remove()}),this._cachedMasks=[]}}});var ke=v(O=>{"use strict";Object.defineProperty(O,"__esModule",{value:!0});O.ZoteroToolkit=void 0;var I=y(),ir=C(),rr=ze(),sr=ht(),or=ft(),nr=pt(),ar=mt(),lr=gt(),cr=bt(),dr=yt(),ur=wt(),hr=kt(),fr=_t(),pr=xt(),mr=Tt(),gr=Ct(),br=Pt(),yr=oe(),vr=Lt(),wr=Zt(),kr=qt(),_r=Se(),xr=St(),we=class extends I.BasicTool{constructor(){super(),this.UI=new ir.UITool(this),this.Reader=new rr.ReaderTool(this),this.ExtraField=new sr.ExtraFieldTool(this),this.FieldHooks=new yr.FieldHookManager(this),this.ItemTree=new or.ItemTreeManager(this),this.ItemBox=new vr.ItemBoxManager(this),this.Keyboard=new kr.KeyboardManager(this),this.Prompt=new nr.PromptManager(this),this.LibraryTabPanel=new ar.LibraryTabPanelManager(this),this.ReaderTabPanel=new lr.ReaderTabPanelManager(this),this.ReaderInstance=new br.ReaderInstanceManager(this),this.Menu=new cr.MenuManager(this),this.PreferencePane=new dr.PreferencePaneManager(this),this.Shortcut=new ur.ShortcutManager(this),this.Clipboard=(0,I.makeHelperTool)(hr.ClipboardHelper,this),this.FilePicker=(0,I.makeHelperTool)(fr.FilePickerHelper,this),this.Patch=(0,I.makeHelperTool)(_r.PatchHelper,this),this.ProgressWindow=(0,I.makeHelperTool)(pr.ProgressWindowHelper,this),this.VirtualizedTable=(0,I.makeHelperTool)(mr.VirtualizedTableHelper,this),this.Dialog=(0,I.makeHelperTool)(gr.DialogHelper,this),this.LargePrefObject=(0,I.makeHelperTool)(wr.LargePrefHelper,this),this.Guide=(0,I.makeHelperTool)(xr.GuideHelper,this)}unregisterAll(){(0,I.unregister)(this)}};O.ZoteroToolkit=we;O.default=we});var _e=xe(ke());var Ft=xe(ke());function it(s){return(0,Ft.getString)(s,"zotero-auto-tagger")}var Vt=xe(ke()),rt=class{constructor(){this.config={gptApiEndpoint:"https://api.openai.com/v1/chat/completions",gptModel:"gpt-4-turbo-preview",maxPagesToProcess:10};this.toolkit=new Vt.ZoteroToolkit}async createEntryFromPDF(e){if(!e.length){this.showError("Please select at least one PDF item.");return}let t=this.toolkit.getProgressWindow("Processing PDFs");t.show();try{for(let i of e)if(i.isAttachment()&&i.attachmentContentType==="application/pdf"){this.toolkit.log(`Processing PDF: ${i.getField("title")}`);let r=await i.getFilePathAsync();if(!r){this.toolkit.log("Could not get file path for PDF");continue}let o=new Zotero.Item("journalArticle"),a=new Zotero.Translate.ItemGetter;a.attachmentFile=r;let n=await a.translate();n?.length>0?(Object.entries(n[0]).forEach(([c,l])=>{c!=="itemType"&&o.setField(c,l)}),await o.saveTx(),i.parentID=o.id,await i.saveTx(),this.toolkit.log("Successfully created entry from PDF")):this.toolkit.log("No metadata extracted from PDF")}}catch(i){this.showError(`Error processing PDFs: ${i instanceof Error?i.message:String(i)}`),this.toolkit.log(`Error in createEntryFromPDF: ${i instanceof Error?i.stack:String(i)}`)}finally{await Zotero.Promise.delay(2e3),t.close()}}async autoTagItems(e){if(!e.length){this.showError("Please select at least one item to tag.");return}let t=this.toolkit.getProgressWindow("Auto-tagging items");t.show();try{for(let i of e)this.toolkit.log(`Auto-tagging item: ${i.getField("title")}`)}catch(i){this.showError(`Error auto-tagging items: ${i instanceof Error?i.message:String(i)}`),this.toolkit.log(`Error in autoTagItems: ${i instanceof Error?i.stack:String(i)}`)}finally{await Zotero.Promise.delay(2e3),t.close()}}showError(e){let t=this.toolkit.getProgressWindow("Error");t.createLine({text:e,type:"error"}),t.show(),t.startCloseTimer(8e3)}},st=new rt;var ot=class{constructor(){this.data={alive:!0,toolkit:new _e.ZoteroToolkit}}async onStartup(){await this.initializePreferences(),this.registerMenuItems()}async onShutdown(){this.data.alive=!1,await(0,_e.unregister)()}async initializePreferences(){}registerMenuItems(){if(Zotero.ItemTreeView&&Zotero.ItemTreeView.prototype){let e=Zotero.ItemTreeView.prototype.onPopup;Zotero.ItemTreeView.prototype.onPopup=function(t){let i=e.apply(this,arguments);try{let r=Zotero.getActiveZoteroPane().getSelectedItems();if(r.length){t.target.appendChild(document.createXULElement("menuseparator"));let o=document.createXULElement("menuitem");o.setAttribute("label",it("menuitem-autotag-label")),o.addEventListener("command",()=>st.autoTagItems(r)),t.target.appendChild(o);let a=document.createXULElement("menuitem");a.setAttribute("label",it("menuitem-createentry-label")),a.addEventListener("command",()=>st.createEntryFromPDF(r)),t.target.appendChild(a)}}catch(r){this.data.toolkit.log("Error in Auto-Tagger menu popup: "+r)}return i}}}},ss=new ot;})();
